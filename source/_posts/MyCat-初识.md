---
title: MyCat 初识
tags:
  - 数据库
  - mysql
categories:
  - 工具
date: 2020-02-19 13:38:58
---

### 概述

互联网时代，海量数据的存储和访问成为了系统设计与使用的瓶颈问题。这篇文章介绍了一个解决大数据量存储和查询新能问题的数据库中间件——MyCat，主要介绍了 MyCat 的一下概念，以及安装测试过程。

### 认识 MyCat

![](http://blog-images.qiniu.wqf31415.xyz/mycat_logo.png)

> 官网：<http://www.mycat.io> 

MyCat 是一个国内的、开源的、通用（兼容绝大多数数据库）的、高性能的、分布式的数据库中间件。Mycat 是用 java 语言编写的，基于阿里开源稳定的 Cobar 演变而来，经过开发团队彻底重构，使用 NIO 重构了网络模块，优化了 Buffer 内核，增强了聚合、Join 等基本特性。



<!-- more -->



用户可以把 MyCat 看作是一个数据库代理，可以直接使用 MySql 客户端或命令行访问，后端程序只需要改一下数据库连接配置就可以直接使用。而 MyCat 还支持跨数据库使用，不仅支持 MySql、Oracle、PostgreSql 等关系型数据库，还支持 MongoDB 这种 NoSQL ，但从业务端来看，面对的还是一个传统的数据库表，使用标准 SQL 进行操作，对于开发者来说就无需修改代码和增加复杂的配置，提高了开发速度。

MyCat 崇尚开源，承诺永不收费，永不闭源，持续推送开源社区的发展。

### 相关概念

#### MyCat 中的概念

##### 数据库中间件

数据库中间件是介于数据库和应用之间，进行数据处理与交互的中间服务，数据库中间件可以帮我们完成分片数据的读取，处理多个数据源、事务、聚合等任务。数据库中间件的性能与处理能力直接决定应用的读写性能。

##### 逻辑库（Schema）

对于应用来说，并不需要知道中间件的存在，开发人员只需要知道数据库的概念，所以数据库中间件可以被看做是一个或多个数据库集群构成的逻辑库。

##### 逻辑表（Table）

在分布式数据库中，对应用来说，读写数据的表就是逻辑表。

- 分片表，指那些原本很大数据的表，需要切分到多个数据库的表，每个分片都有一部分数据，所有分片构成了完整的数据。

- 非分片表，数据量比较小的不需要做切分的表

- ER 表，基于实物关系模型(Entity-Relationship Model) 的数据分片策略，字表的记录与所关联的父表记录存放在同一个数据分片上，即字表依赖于父表，通过表分组保证数据 join 不会跨库操作。

- 全局表，在业务系统中变动很少，类似字典表的表。特点是变动不频繁，数据量总体变化不大，数据规模不大，很少有超过数十万条记录。

  > MyCat 中通过数据冗余来解决字典表的 join，即所有分片上都有一份数据的拷贝，将所有字典表或具有字典表特性的表定义成全局表。

##### 分片节点（dataNode）

数据切分后，一张大表被分到不同的分片数据库上，每个表分片所在的数据库就是分片节点。

##### 节点主机（dataHost）

数据切分后，每个分片节点不一定独占一台机器，同一机器上面可以有多个分片数据库，这样一个或多个分片节点所在的机器就是节点主机。

为了规避单节点主机并发数限制，尽量将读写压力高的分片节点均衡的放在不同的节点主机上。

##### 分片规则（rule）

要将一张大表切分成数个分片表，就需要一定的规则，选择合适的分片规则非常重要，将极大地避免后续数据处理的难度。

##### 全局序列号（sequence）

数据切分后，原有的关系数据库主键约束在分布式条件下将无法使用，因此需要引入外部机制保证数据唯一性标识，这种保证全局性的数据唯一标识的机制就是全局序列号。

#### 数据切分

数据切分是按某种特定的条件，将存放在同一数据库中的数据分散存放到多个数据库，达到分散单台设备负载的效果。根据切分规则不同，可以分为垂直（纵向）切分、水平（横向）切分。

##### 垂直切分

垂直切分是按不同的表（或 schema）来切分到不同的数据库上。垂直拆分的优点是规则简单，实施方便，尤其适合各业务之间耦合度非常低，相互影响很小，业务逻辑非常清晰的系统。对于按模块开发的应用，垂直切分就非常方便，比如拆分成用户系统、订单系统、支付系统等。

> 在实际开发中，往往有些表难以做到完全独立，存在着 join 的情况，对于这类的表，就需要去做平衡，是数据库让步业务，共用一个数据源，还是分成多个库，业务之间通过接口来调用。

一般业务存在复杂 join 的场景是难以切分的，业务独立的易于切分。



##### 水平切分

水平切分是根据表中的数据的逻辑关系，将一个表中的数据按照某种条件拆分到多台数据库上。水平拆分稍微复杂一些，需要将一个表中数据拆分到不同数据库，拆分规则本身比按表名拆分更复杂，后期的数据维护也会更为复杂一些。

水平拆分是按照某个字段的某种规则来分散到多个库中，每个库中包含一部分数据。

常见的水平分片规则：

- 按用户 ID 求模，将数据分散到不同数据库，具有相同 ID 用户的数据都被分到一个库中
- 按照日期，将不同月、日的数据分散到不同库中
- 按照某个特定字段求模，或根据特定范围分散到不同库中，比如按地区切分



#### 不同人眼中的 MyCat

##### DBA

> MyCat 就是 MySQL Server，而 MyCat 后面连接的 MySQL Server，就好像是 MySQL 的存储引擎，如 InnoDB、MyISAM 等。因此，MyCat 本身并不存储数据，数据是在后端的 MySQL 上存储的，因此数据可靠性以及事物等都是 MySQL 保证的。简单说，MyCat 就是 MySQL 最佳伴侣，它在一定程度上让 MySQL 拥有跟 Oracle PK 的能力。

#####软件工程师

> MyCat 就是一个近似等于 MySQL 的数据库服务器，你可以用连接 MySQL 的方式去连接 MyCat（除了端口不同，MyCat 默认端口 8066，而非 MySQL 的 3306），大多数情况，可以用你熟悉的对象映射框架使用 MyCat，但建议对于分片表，尽量使用基础的 SQL 语句，因为这样能达到最佳性能，特别是几千万甚至几百亿条记录的情况下。

##### 架构师

> MyCat 是一个强大的数据库中间件，不仅可以做读写分离、分库分表、容灾备份，还可以用于多租户应用开发、云平台基础设施、让你的架构具有很强的适应性和灵活性，借助即将发布的 MyCat 智能优化模块，系统的数据访问瓶颈和热点一目了然，根据这些统计分析数据，你可以自动或手动调整后端存储，将不同的表映射到不同存储引擎上，而整个应用的代码一行也不用改。



#### MyCat 原理

MyCat 原理中最重要的一个动作是 `拦截` ，它拦截了用户发过来的 SQL 语句，先对 SQL 做一些特定的分析，如：分片分析、路由分析、读写分离分析、缓存分析等，然后将此 SQL 发往后端的真实数据库并将返回的结果做适当的处理，最终再返回给用户。



#### MyCat 应用场景

- 读写分离、主从切换
- 分库分表，对超过 1000 万的表进行分片，最大支持 1000 亿的单表分片
- 多租户应用，每个应用一个库，但应用程序只连接 MyCat，从而不改造程序本身，实现多租户化
- 报表系统，借助于 MyCat 的分表能力，处理大规模报表的统计
- 替代 Hbase，分析大数据
- 海量数据实时查询的一种简单有效方案，比如 100 亿条频繁查询的记录需要在 3 秒内查询出结果，处理基于主键的查询，还可能存在范围查询或其他属性查询，此时 MyCat 可能是最简单有效的选择



### 安装体验

#### 环境

- jdk，需要1.7 及以上版本的 JDK。

- MySQL，MyCat 支持多种数据库，推荐使用 MySQL 做集群。可以使用 docker 开启多个 mysql 实例来进行测试。
- MyCat，官网 <http://www.mycat.io>  下载，提供编译好的安装包，支持 Windows、Linux、Mac、Solaris等系统。

#### 启动

我使用的是 Windows 操作系统来做测试，下载对应压缩包后，将其解压出来，放到一个没有中文和空格的目录下。

进入 `bin` 目录，运行 `mycat.bat` 就可以在控制台中启动程序，也可以运行 `startup_nowrap.bat` 启动。

#### MyCat 配置

##### 防火墙配置

在 `server.xml` 中可以配置白名单和黑名单，限定访问 IP 和权限。

如：

```xml
<firewall>
    <whitehost>
    	<host user="mycat" host="127.0.0.1"></host> 
    </whitehost>
    <blacklist check="true">
    	<property name="selelctAllow">false</property> 
    </blacklist>
</firewall>
```

##### Schema 配置

在 `Schema.xml` 中可以配置 MyCat 逻辑库、表、分片规则、DataNode 和 DataSource，搞懂这些配置是使用 MyCat 的基础。

在 `Schema.xml` 文件中， `schema` 标签用来定义逻辑库，可有有多个逻辑库，每个逻辑库有自己相关的配置。

```xml
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100">
	<table name="travelrecord" dataNode="dn1,dn2,dn3" rule="auto-sharding-long" ></table>
</schema>
```

`schema` 标签相关属性：

| 属性           | 功能                                                         | 值          | 数量限制 |
| -------------- | ------------------------------------------------------------ | ----------- | -------- |
| dataNode       | 指定数据分片节点                                             | 任意 String | (0..1)   |
| checkSQLschema | 是否检查 SQL语句中的 schema，如果跟当前 `schema` 中名称相同，则会将 sql 中的 schema 去掉 | Boolean     | (1)      |
| sqlMaxLimit    | 如果 sql 语句中没有 limit 限定查询条数，将自动添加查询限定条数 | Integer     | (1)      |

##### table 配置

`table` 标签用于定义逻辑表，所有需要拆分的表都需要在这个标签中定义。

```xml
<table name="travelrecord" dataNode="dn1,dn2,dn3" rule="auto-sharding-long"></table>
```

相关属性：

| 属性          | 功能                                                         | 值      | 数量     |
| ------------- | ------------------------------------------------------------ | ------- | -------- |
| name          | d                                                            | String  | （1）    |
| dataNode      | 逻辑表所属的分片节点，<abbr title="这个属性的值需要和 dataNode 标签中的 name 属性值相互对应">注</abbr> | String  | （1..*） |
| rule          | 逻辑表使用的规则名称，规则名称在 `rule.xml` 中定义，<abbr title="这个属性值必须与 tableRule 标签中的 name 属性值对应">注</abbr> | String  | （0..1） |
| ruleRequired  | 指定表是否绑定分片规则，<abbr title="如果值为 true 但未配置具体 rule 程序会报错">注</abbr> | Boolean | （0..1） |
| primaryKey    | 逻辑表对应真实表的主键，<abbr title="分片规则是使用非主键进行分片，在使用主键查询时，将会发送查询语句到所有配置的 DN 上；如果使用该属性配置真实表的主键，那么MyCat会缓存主键与具体DN的信息，下次再使用非主角进行查询时就不会进行广播式查询，而是直接发送查询语句给具体的 DN">例如</abbr> | String  | （1）    |
| type          | 定义逻辑表的类型，目前只有：全局表(`global`) 和普通表(不指定该值) | String  | （0..1） |
| autoIncrement | 指定表有使用自增长主键，默认值 `false`                       | Boolean | （0..1） |
| subTables     | 分表，添加方式：`subTables="t_order$1-2,t_order3"`           | String  | （1）    |
| needAddLimit  | 是否需要自动在每条语句后面加上 limit 限制。默认为 `true` ，默认限制数量为 `100` | Boolean | （0..1） |



#### 测试





### 参考资料

- [《MyCat 权威指南》](http://www.mycat.io/document/mycat-definitive-guide.pdf) 



### 总结

官方文档真的特别良心，从基本原理到实际应用场景，应有尽有，而且都是中文，真是太棒了！只是有一点不太好，pdf 文档阅读没有目录大纲，内容又特别多，导致看的时候想要跳一下要翻到文档开头的目录去找。另外文档中有个别错别字，不过影响不大。总的来说，这次 MyCat 初体验非常舒心！

