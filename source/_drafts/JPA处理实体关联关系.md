---
title: JPA处理实体关联关系
tags:
  - java 
  - springboot
  - jpa
categories:
  - java
date: 2020-12-17 12:07:43
---

### 概述

在项目开发中必不可少的会遇到实体之间带有关联关系的情况，比如班级和学生，作者和文章等等。这些关联关系在项目中需要小心处理，否则可能会出现错误，尤其是进行关联查询的时候。



### 关联关系

关联关系是指一个对象与另一个对象有某种类型的关联，关联的类型包括：

- 一对一（OneToOne）：一个对象仅有另一个对象与之对应，如丈夫和妻子（现代中国）、公民和身份证号码、用户和用户配置、班级和班主任。
- 一对多（OneToMany）：一个对象有多个其他对象与之对应，如一个作者著有多本书、一个班级有多名学生、一个皇帝有多个妃子。
- 多对一（ManyToOne）：多个对象与一个对象对应，与一对多相似，只是从多的这方的角度来看的。如多个职员属于一个部门、多部汽车都是同一品牌。
- 多对多（ManyToMany）：一个类的多个对象与另一类多个对象有对应关系，如课程和学生，一门课程可以被多个学生选择，一个学生也可以选择多门课程。



<!-- more -->

### 相关注解说明

> 以下注解说明基于 `javax.persistence:javax.persistence-api:2.2` 

#### `@OneToOne` 

表示一对一关联，可用于字段（field）、方法（method）。

可以不显式的写出来，因为通过字段的类型就可以推测出其中的关联关系。如果是双向关联关系，没有所有权（non-owning）的一方，即关系被拥有方，必须在 `@OneToOne` 注解中使用 `mappedBy` 指定拥有方的字段或属性。

`@OneToOne` 注解可用于内嵌类，指定内嵌类和外部类的关系。如果是双向关联关系，并且包含内嵌类的实体是关系拥有方，非关系拥有（non-owning）方必须在 `@OneToOne` 注解中使用 `mappedBy` 指定内嵌类的关系字段或属性。在使用 `mappedBy` 指定内嵌属性的关系属性时必须使用点 `.` 符号语法。每个内嵌使用点符号的标识符的值为嵌入属性或字段的名称。

> 在双向关联关系中，拥有关系的一方有建立、解除和更新与另一方关系的能力；另一方没有，只能被动管理。有双向关联的有： `@OneToOne` 、`@OneToMany` 、`@ManyToMany` 。

参数：

| 参数          | 是否必须 | 含义                                                         | 默认值           |
| ------------- | -------- | ------------------------------------------------------------ | ---------------- |
| targetEntity  | 否       | 关联的目标实体类                                             | 当前字段的类型   |
| cascade       | 否       | 与关联目标的级联操作                                         | 空，不做任何操作 |
| fetch         | 否       | 获取策略（`EAGER` - 查询主类时立即获取；`LAZY` - 访问时才获取） | `EAGER`          |
| optional      | 否       | 关联关系是否可选，如果是 `false` 则必须存在一个非空关系      | `true`           |
| mappedBy      | 否       | 拥有关系的字段，如果是单向关联则不需要，双向关联时，这个属性被定义在关系被拥有方。 | `""`             |
| orphanRemoval | 否       | 孤儿移除，在删除主实体时，是否删除关联的子实体               | `false`          |

> 级联操作类型（CascadeType，枚举）：
>
> - `ALL` 级联所有操作
> - `PERSIST` 级联持久化操作
> - `MERGE` 级联合并操作
> - `REMOVE` 级联移除操作
> - `REFRESH` 级联刷新操作
> - `DETACH` 级联分离操作
>
> orphanRemoval （孤儿移除）：如果要删除父实体，也必须级联删除子实体，需要被删除的级联关系中的子实体被称为孤儿实体。orphanRemoval 用于指定是否删除孤儿实体。



#### `@ManyToOne` 

表示多对一关联，可用于字段、方法。

这个注解可以不显式指定，因为可以通过对象类型推断。如果是双向关联，在被关联一方需要使用 `mappedBy` 指定关系拥有方的字段或属性。

可用于内嵌类，如果是双向关联，在被关联方需要使用 `mappedBy` 声明关联方的字段或属性，需要使用点 `.` 符号语法来指定内嵌类的字段。

参数：

| 参数         | 是否必须 | 含义               | 默认值     |
| ------------ | -------- | ------------------ | ---------- |
| targetEntity | 否       | 关联的目标实体类型 | 当前值类型 |
| cascade      | 否       | 级联处理           | 空         |
| fetch        | 否       | 获取策略           | `EAGER`    |
| optional     | 否       | 关系是否可选       | true       |



#### `@OneToMany` 

表示多对一关联，可用于方法、字段。

如果一个集合（collection）使用泛型定义了元素类型，则无需指定关联目标实体类型，否则必须指定目标实体类型。

如果是双向关联，需要使用 `mappedBy` 指定关系拥有者的属性或字段。

注解可能被用于内嵌类，如果是双向关联，需要使用 `mappedBy` 指定关联关系的拥有方的字段或属性。

当集合类型是 `java.util.Map` 时，`cascade` 和 `orphanRemoval` 作用于 map 的值（value）。

参数：

| 参数          | 是否必须 | 含义                                       | 默认值                                                       |
| ------------- | -------- | ------------------------------------------ | ------------------------------------------------------------ |
| targetEntity  | 否       | 目标实体类型                               | 当使用泛型定义集合时，默认为泛型指定的类型；否则无默认值，必须手动指定 |
| cascade       | 否       | 级联操作                                   | 无                                                           |
| fetch         | 否       | 获取策略                                   | `LAZY`                                                       |
| mappedBy      | 否       | 关系拥有方的字段                           | 单向关联时，默认值为 `""`，双向关联时无默认值，须手动指定    |
| orphanRemoval | 否       | 孤儿移除，删除主体时是否删除集合中的子元素 | false                                                        |



#### `@ManyToMany` 

表示多对多关联，可用于方法、字段。

每个多对多关联有两方：关联方（owning）、被关联方（non-owning）。连接表（join table）在关联方指定。如果是双向关联，每一方都可以被指定为关联方，被关联方需要使用 `mappedBy` 指定关联方字段或属性。

多对多关联的连接表，如果不是默认值，则需要在关联方指定。

注解可用于内嵌类，需如果是双向关联，需要在被关联方使用 `mappedBy` 指定关联方中的字段。

参数：

| 参数         | 是否必须 | 含义         | 默认值                                                     |
| ------------ | -------- | ------------ | ---------------------------------------------------------- |
| targetEntity | 否       | 关联目标类型 | 如果集合使用了泛型，则默认为泛型指定类型，否则需要手动指定 |
| cascade      | 否       | 级联操作     | 空                                                         |
| fetch        | 否       | 获取策略     | `LAZY`                                                     |
| mappedBy     | 否       | 关联方字段   | 双向关联时                                                 |



#### `@MapsId` 

用于在 `@OneToOne` 或 `@ManyToOne` 注解的字段，表示关联关系的字段是父类的主键或者使用 `@EmbeddedId` 标识的字段。主键中 `value` 属性用于指定关系属性对应组合键中的属性名，如果没有指定则默认为实体的主键。



#### `@JoinTable` 

用于指定关联映射，用在关系关联（owning）方。



#### `@JoinColumn` 

指定连接一个实体关联或元素集合的列。



### 代码示例

#### domain 



#### repository 



#### service 



#### controller 



### 参考资料

- 一对一关联查询注解@OneToOne的实例详解: <https://www.cnblogs.com/boywwj/p/8092915.html> 
- jpa中orphanremoval技术的作用与属性详解: <http://www.itjcw123.cn/2747.html> 



### 总结

