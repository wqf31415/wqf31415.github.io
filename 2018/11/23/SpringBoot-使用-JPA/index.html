<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/uploads/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon.png">
  <link rel="mask-icon" href="/uploads/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.wqf31415.xyz","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="内容概述 这篇文章主要讲解了 JPA 相关的概念，以及如何在一个 SpringBoot 项目中使用 spring-data-jpa 来操作数据库，包括创建 Entity，自动建表，基础的增删改查，自定义查询方法，JPQL，原生sql查询，Specification 查询。  什么是 JPA ？ JPA，即 Java Persistence API ，中文意为Java持久层API，是 Sun 公司">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot 使用 JPA">
<meta property="og:url" content="https://www.wqf31415.xyz/2018/11/23/SpringBoot-%E4%BD%BF%E7%94%A8-JPA/index.html">
<meta property="og:site_name" content="This_Wei">
<meta property="og:description" content="内容概述 这篇文章主要讲解了 JPA 相关的概念，以及如何在一个 SpringBoot 项目中使用 spring-data-jpa 来操作数据库，包括创建 Entity，自动建表，基础的增删改查，自定义查询方法，JPQL，原生sql查询，Specification 查询。  什么是 JPA ？ JPA，即 Java Persistence API ，中文意为Java持久层API，是 Sun 公司">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog-images.qiniu.wqf31415.xyz/spring_boot_jpa_start.png">
<meta property="article:published_time" content="2018-11-23T06:27:32.000Z">
<meta property="article:modified_time" content="2023-05-23T02:54:17.262Z">
<meta property="article:author" content="This_Wei">
<meta property="article:tag" content="java">
<meta property="article:tag" content="springboot">
<meta property="article:tag" content="jpa">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="database">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog-images.qiniu.wqf31415.xyz/spring_boot_jpa_start.png">


<link rel="canonical" href="https://www.wqf31415.xyz/2018/11/23/SpringBoot-%E4%BD%BF%E7%94%A8-JPA/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.wqf31415.xyz/2018/11/23/SpringBoot-%E4%BD%BF%E7%94%A8-JPA/","path":"2018/11/23/SpringBoot-使用-JPA/","title":"SpringBoot 使用 JPA"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SpringBoot 使用 JPA | This_Wei</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?573d2959947383d4158d7b1756b9d63c"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">This_Wei</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Come on!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-nav"><a href="/nav/" rel="section"><i class="fa fa-sitemap fa-fw"></i>收藏导航</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AE%B9%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text"> 内容概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-jpa"><span class="nav-number">2.</span> <span class="nav-text"> 什么是 JPA ？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-spring-data-jpa"><span class="nav-number">3.</span> <span class="nav-text"> 使用 spring-data-jpa</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="nav-number">3.1.</span> <span class="nav-text"> 创建项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text"> 修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93"><span class="nav-number">3.3.</span> <span class="nav-text"> 创建实体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%BB%BA%E8%A1%A8"><span class="nav-number">3.4.</span> <span class="nav-text"> 自动建表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E6%8F%92%E5%85%A5%E5%88%9D%E5%A7%8B%E6%95%B0%E6%8D%AE"><span class="nav-number">3.5.</span> <span class="nav-text"> 自动插入初始数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-repository"><span class="nav-number">3.6.</span> <span class="nav-text"> 创建 Repository</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80-%E7%BB%A7%E6%89%BF-jparepository-%E6%8E%A5%E5%8F%A3-%E6%8E%A8%E8%8D%90"><span class="nav-number">3.6.1.</span> <span class="nav-text"> 方式一 继承 JpaRepository 接口 (推荐)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C-%E4%BD%BF%E7%94%A8-repositorydefinition-%E6%B3%A8%E8%A7%A3"><span class="nav-number">3.6.2.</span> <span class="nav-text"> 方式二 使用 @RepositoryDefinition 注解</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-service"><span class="nav-number">3.7.</span> <span class="nav-text"> 创建 Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-controller"><span class="nav-number">3.8.</span> <span class="nav-text"> 创建 Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">3.9.</span> <span class="nav-text"> 单元测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9F%A5%E8%AF%A2%E6%96%B9%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text"> 自定义查询方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%9F%A5%E8%AF%A2%E6%96%B9%E6%B3%95"><span class="nav-number">4.1.</span> <span class="nav-text"> 创建查询方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F%E4%B8%8E%E5%88%86%E9%A1%B5"><span class="nav-number">4.2.</span> <span class="nav-text"> 排序与分页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%B9%E6%B3%95%E7%9A%84%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="nav-number">4.3.</span> <span class="nav-text"> 查询方法的解析流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E9%99%90%E5%88%B6"><span class="nav-number">4.4.</span> <span class="nav-text"> 查询结果限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E6%95%B0%E6%9F%A5%E8%AF%A2%E4%B8%8E%E5%88%A0%E9%99%A4%E6%96%B9%E6%B3%95"><span class="nav-number">4.5.</span> <span class="nav-text"> 计数查询与删除方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jpql-%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.</span> <span class="nav-text"> JPQL 查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jpql-%E7%9A%84-select"><span class="nav-number">5.1.</span> <span class="nav-text"> JPQL 的 SELECT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jpql-%E7%9A%84-update"><span class="nav-number">5.2.</span> <span class="nav-text"> JPQL 的 UPDATE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jpql-%E7%9A%84-delete"><span class="nav-number">5.3.</span> <span class="nav-text"> JPQL 的 DELETE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.4.</span> <span class="nav-text"> 联合查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E4%B8%8E%E9%83%A8%E5%88%86%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84%E6%8A%95%E5%BD%B1"><span class="nav-number">5.5.</span> <span class="nav-text"> 关联查询与部分字段映射投影</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jpql-%E5%91%BD%E5%90%8D%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.6.</span> <span class="nav-text"> JPQL 命名查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jpql-%E5%87%BD%E6%95%B0"><span class="nav-number">5.7.</span> <span class="nav-text"> JPQL 函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.</span> <span class="nav-text"> 原生查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.1.</span> <span class="nav-text"> 简单的原生查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E7%9A%84%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.2.</span> <span class="nav-text"> 分页的原生查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%94%E8%A1%A8%E7%9A%84%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.3.</span> <span class="nav-text"> 联表的原生查询</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#specification-%E6%9F%A5%E8%AF%A2"><span class="nav-number">7.</span> <span class="nav-text"> Specification 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-number">8.</span> <span class="nav-text"> 多数据源</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">8.1.</span> <span class="nav-text"> 相同数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-number">8.1.1.</span> <span class="nav-text"> 配置多数据源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B0%86%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%9F%9F%E7%9A%84%E5%AE%9E%E4%BD%93%E7%B1%BB-repository-%E6%94%BE%E5%88%B0%E4%B8%8D%E5%90%8C%E5%8C%85%E4%B8%8B"><span class="nav-number">8.1.2.</span> <span class="nav-text"> 将不同数据域的实体类、Repository 放到不同包下</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E6%9C%8D%E5%8A%A1%E7%B1%BB%E4%B8%8E%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">8.1.3.</span> <span class="nav-text"> 编写服务类与接口进行测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">8.2.</span> <span class="nav-text"> 不同数据库</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jpa-%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="nav-number">9.</span> <span class="nav-text"> JPA 的缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">10.</span> <span class="nav-text"> 注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jpa-%E6%98%AF%E4%B8%80%E5%A5%97%E6%A0%87%E5%87%86"><span class="nav-number">10.1.</span> <span class="nav-text"> JPA 是一套标准</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A9%B1%E5%8A%A8%E9%94%99%E8%AF%AF"><span class="nav-number">10.2.</span> <span class="nav-text"> 驱动错误</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E5%8C%BA%E9%94%99%E8%AF%AF"><span class="nav-number">10.3.</span> <span class="nav-text"> 时区错误</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E4%BD%93%E5%8C%B9%E9%85%8D%E9%94%99%E8%AF%AF"><span class="nav-number">10.4.</span> <span class="nav-text"> 实体匹配错误</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F-sql-%E8%BF%9B%E8%A1%8C%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%97%B6%E6%8A%A5%E9%94%99%E6%8F%90%E7%A4%BA%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E9%A1%B5"><span class="nav-number">10.5.</span> <span class="nav-text"> 原生 sql 进行分页查询时报错提示不能使用排序和分页</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">11.</span> <span class="nav-text"> 参考资料</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E5%AE%83"><span class="nav-number">12.</span> <span class="nav-text"> 其它</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">This_Wei</p>
  <div class="site-description" itemprop="description">昨夜西风凋碧树，独上高楼，望尽天涯路！</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="http://wpa.qq.com/msgrd?v=3&uin=629170023&site=qq&menu=yes" title="QQ → http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;629170023&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener me" target="_blank"><i class="qq fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/wqf31415" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wqf31415" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wqf31415@hotmail.com" title="E-Mail → mailto:wqf31415@hotmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/wqf31415" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;wqf31415" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.wqf31415.xyz/2018/11/23/SpringBoot-%E4%BD%BF%E7%94%A8-JPA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="This_Wei">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="This_Wei">
      <meta itemprop="description" content="昨夜西风凋碧树，独上高楼，望尽天涯路！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SpringBoot 使用 JPA | This_Wei">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringBoot 使用 JPA<a href="https://github.com/wqf31415/wqf31415.github.io/tree/source/source/_posts/SpringBoot-%E4%BD%BF%E7%94%A8-JPA.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-11-23 14:27:32" itemprop="dateCreated datePublished" datetime="2018-11-23T14:27:32+08:00">2018-11-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-23 10:54:17" itemprop="dateModified" datetime="2023-05-23T10:54:17+08:00">2023-05-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="内容概述"><a class="markdownIt-Anchor" href="#内容概述"></a> 内容概述</h3>
<p>这篇文章主要讲解了 JPA 相关的概念，以及如何在一个 SpringBoot 项目中使用 spring-data-jpa 来操作数据库，包括创建 Entity，自动建表，基础的增删改查，自定义查询方法，JPQL，原生sql查询，Specification 查询。</p>
<h3 id="什么是-jpa"><a class="markdownIt-Anchor" href="#什么是-jpa"></a> 什么是 JPA ？</h3>
<p>JPA，即 Java Persistence API ，中文意为Java持久层API，是 Sun 公司提出的一套标准，用于将运行期对象持久化存储到数据库，具体实现的产品有： Hiberate、Eclipselink、Toplink、Spring Data JPA等。</p>
<span id="more"></span>
<h3 id="使用-spring-data-jpa"><a class="markdownIt-Anchor" href="#使用-spring-data-jpa"></a> 使用 spring-data-jpa</h3>
<h4 id="创建项目"><a class="markdownIt-Anchor" href="#创建项目"></a> 创建项目</h4>
<p>简单起见，直接使用 <a target="_blank" rel="noopener" href="http://start.spring.io">http://start.spring.io</a> 来创建项目，添加3个依赖: <code>JPA</code> 、 <code>MySQL</code> 、 <code>Web</code> 。<br />
<img src="http://blog-images.qiniu.wqf31415.xyz/spring_boot_jpa_start.png" alt="" title="创建 jpademo 项目" /><br />
demo 项目中的 pom.xml 如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jpademo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>jpademo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="修改配置文件"><a class="markdownIt-Anchor" href="#修改配置文件"></a> 修改配置文件</h4>
<p>修改 <code>application.properties</code> 文件，添加连接数据源需要的 url、username、password ：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/testjpa?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"># 下面这个配置项表示是否需要自动创建数据库表，可选值有：none 不自动创建; create 每次项目启动时自动创建; create-drop 项目启动时创建表，项目关闭时删除; update 有需要时更新数据库; validate 验证数据库，但不更新; </span></span><br><span class="line"><span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">create</span></span><br><span class="line"><span class="comment"># 打印出sql语句，可用于开发调试</span></span><br><span class="line"><span class="attr">spring.jpa.show-sql</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
<h4 id="创建实体"><a class="markdownIt-Anchor" href="#创建实体"></a> 创建实体</h4>
<p>实体类与数据库表对应，实体类中包含对象属性，相应的 setter、getter方法和 toString 方法。在 JPA 中通过给类添加 <code>@Entity</code> 注解表明这个类是实体类。<br />
创建一个 <code>domain</code> 包，创建一个 <code>Student</code> 类，给这个类加上 <code>@Entity</code> 注解，给主键字段加上 <code>@Id</code> 和 <code>@GeneratedValue</code> 注解，给其它字段加上 <code>@Column</code> 注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.ZonedDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> ZonedDateTime birthday;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> Boolean active;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ZonedDateTime <span class="title function_">getBirthday</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBirthday</span><span class="params">(ZonedDateTime birthday)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.birthday = birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">getActive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> active;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setActive</span><span class="params">(Boolean active)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.active = active;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, birthday=&quot;</span> + birthday +</span><br><span class="line">                <span class="string">&quot;, active=&quot;</span> + active +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自动建表"><a class="markdownIt-Anchor" href="#自动建表"></a> 自动建表</h4>
<p>在 springboot jpa 项目配置文件中添加配置项 <code>spring.jpa.hibernate.ddl-auto=create</code> ，项目启动时会自动扫描全部实体类，并在数据库中创建相应的表。<br />
添加完实体类后，运行一下项目，发现打出的 sql 语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: drop table if exists hibernate_sequence</span><br><span class="line">Hibernate: drop table if exists student</span><br><span class="line">Hibernate: create table hibernate_sequence (next_val bigint) engine=MyISAM</span><br><span class="line">Hibernate: insert into hibernate_sequence values ( 1 )</span><br><span class="line">Hibernate: create table student (id bigint not null, active bit, age integer, birthday datetime, name varchar(255), primary key (id)) engine=MyISAM</span><br></pre></td></tr></table></figure>
<p>查看数据库，发现多了两张表: <code>hibernate_sequence</code> 和 <code>student</code>。<strong>但是我们使用的 mysql 数据库，不需要sequence来做主键，只需要设置主键值自增就行了</strong>。所以，我们把上面的 <code>Student</code> 类改一下，给 <code>id</code> 字段的 <code>@GeneratedValue</code> 加上主键生成策略参数，修改为 <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> 。<br />
主键生成策略的可选项：</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">GenerationType.AUTO</td>
<td style="text-align:center">(默认值)，主键由 jpa 自动生成</td>
</tr>
<tr>
<td style="text-align:center">GenerationType.IDENTITY</td>
<td style="text-align:center">使用数据库自增值作为主键值，适用于HSQL、SQL Server、MySQL、DB2、Derby 等数据库</td>
</tr>
<tr>
<td style="text-align:center">GenerationType.SEQUENCE</td>
<td style="text-align:center">使用数据库序列号作为主键值，适用于Oracle、PostgreSQL 等数据库</td>
</tr>
<tr>
<td style="text-align:center">GenerationType.TABLE</td>
<td style="text-align:center">使用数据中一张表中某个字段作为主键</td>
</tr>
</tbody>
</table>
<p>重新运行项目，查看日志，发现打出了下面的 sql 语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: drop table if exists student</span><br><span class="line">Hibernate: create table student (id bigint not null auto_increment, active bit, age integer, birthday datetime, name varchar(255), primary key (id)) engine=MyISAM</span><br></pre></td></tr></table></figure>
<p>**请注意建表语句的最后面 “engine=MyISAM” **，发现使用的存储引擎是 <code>MyISAM</code> ，即 My Indexed Sequential Access Method，<code>MyISAM</code> 读取速度很快，不占用大量内存和存储资源，但不支持事务、外来键、索引，适用于有很多 count() 、查询频繁插入不频繁、不需要事务的表。<br />
我们一般需要事务，所以使用的存储引擎是 <code>InnoDB</code> ，如果想改成这种存储引擎，需要在项目配置文件 <code>application.properties</code> 中添加如下配置项：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不加这句则默认为 MyISAM 引擎</span></span><br><span class="line"><span class="attr">spring.jpa.database-platform</span>=<span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br></pre></td></tr></table></figure>
<p>经过上面的修改后，建表语句变成了:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student (id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> auto_increment, active bit, age <span class="type">integer</span>, birthday datetime, name <span class="type">varchar</span>(<span class="number">255</span>), <span class="keyword">primary</span> key (id)) engine<span class="operator">=</span>InnoDB</span><br></pre></td></tr></table></figure>
<p>观察后发现：<strong>name 字段的最大长度为 255 ，而实际上我们并不需要这么大的容量</strong>，所以我们需要限制一下，在 <code>name</code> 字段的 <code>@Column</code> 注解中添加 length 参数，改为 <code>@Column(length = 20)</code> ，这样修改后，生成的表将限制最大长度为 20。<br />
<code>@Column</code> 注解参数说明：</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">说明</th>
<th style="text-align:center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">(可选) 建表时使用的字段名</td>
<td style="text-align:center">默认为实体类中的字段名</td>
</tr>
<tr>
<td style="text-align:center">unique</td>
<td style="text-align:center">(可选) 该字段是否唯一</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">nullable</td>
<td style="text-align:center">(可选) 是否可为空</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">insertable</td>
<td style="text-align:center">(可选) 使用的 insert 语句中包含该字段时，该字段是否要插入值</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">updatable</td>
<td style="text-align:center">(可选) 使用的 update 语句中包含该字段时，该字段是否要更新，用于表中的只读字段</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">columnDefinition</td>
<td style="text-align:center">(可选) 字段描述，在用来定义建表时数据库字段属性，如指定字段类型与注释: @Column(columnDefinition = “smallint COMMENT ‘学生年龄’”)</td>
<td style="text-align:center">“”</td>
</tr>
<tr>
<td style="text-align:center">table</td>
<td style="text-align:center">(可选) 包含当前字段的表名。默认值为主表的表名。</td>
<td style="text-align:center">“”</td>
</tr>
<tr>
<td style="text-align:center">length</td>
<td style="text-align:center">(可选) 最大长度，只有字段类型是字符串类型时生效</td>
<td style="text-align:center">255</td>
</tr>
<tr>
<td style="text-align:center">precision</td>
<td style="text-align:center">(可选) 小数的精度，小数数据的长度，仅小数数据类型字段可用</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">scale</td>
<td style="text-align:center">(可选) 小数数据的小数位数，仅小数数据类型字段可用</td>
<td style="text-align:center">0</td>
</tr>
</tbody>
</table>
<p>在自动建表时， <strong>指定表名</strong>：</p>
<ul>
<li>给 <code>@Entity</code> 注解加上 <code>name</code> 参数，改为 <code>@Entity(name = &quot;tb_student&quot;)</code>。</li>
<li>或添加 <code>@Table</code> 注解，并添加 <code>name</code> 参数：<code>@Table(name = &quot;tb_student&quot;)</code>。</li>
</ul>
<p><code>@Entity</code> 注解表明这个类是需要 orm 映射的，只有 <code>name</code> 一个参数，而 <code>@Table</code> 注解中可以修改一些映射的规则。<br />
<code>@Table</code> 注解参数：</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">说明</th>
<th style="text-align:center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">(可选) 表名</td>
<td style="text-align:center">当前类名</td>
</tr>
<tr>
<td style="text-align:center">catalog</td>
<td style="text-align:center">(可选) 数据库名</td>
<td style="text-align:center">配置中指定的数据库</td>
</tr>
<tr>
<td style="text-align:center">schema</td>
<td style="text-align:center">(可选) 查询数据时使用的用户名</td>
<td style="text-align:center">配置中指定的用户名</td>
</tr>
<tr>
<td style="text-align:center">uniqueConstraints</td>
<td style="text-align:center">(可选) 创建单个或联合唯一约束，可以在建表时添加索引</td>
<td style="text-align:center">{}</td>
</tr>
</tbody>
</table>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Table(name = &quot;tb_student&quot;,catalog = &quot;test&quot;,schema = &quot;testjpa&quot;,uniqueConstraints = &#123;@UniqueConstraint(columnNames = &#123;&quot;name&quot;,&quot;age&quot;&#125;)&#125;)</span></span><br><span class="line"><span class="comment">// 将在 test 数据库中创建名为 tb_student 的表，查询时使用 testjpa 的用户查询，并给这张表添加 name 与 age 的唯一约束</span></span><br></pre></td></tr></table></figure>
<p>建表时运行的 sql 如下，在建表完成后，给表添加了约束条件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> test.tb_student;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test.tb_student (id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> auto_increment, active bit, age <span class="type">smallint</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>, birthday datetime, name <span class="type">varchar</span>(<span class="number">20</span>), <span class="keyword">primary</span> key (id)) engine<span class="operator">=</span>InnoDB;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test.tb_student <span class="keyword">add</span> <span class="keyword">constraint</span> UKjryppi07bm3jtculd9mtfjtjf <span class="keyword">unique</span> (name, age);</span><br></pre></td></tr></table></figure>
<h4 id="自动插入初始数据"><a class="markdownIt-Anchor" href="#自动插入初始数据"></a> 自动插入初始数据</h4>
<p>当配置项 <code>spring.jpa.hibernate.ddl-auto</code> 的值为 <code>create</code> 或 <code>create-drop</code> 时，项目启动建表完成后，会扫描 classpath 下(默认为resource目录)的 <code>import.sql</code> 文件，如果有就会执行这个脚本，我们可以在这里面添加插入数据的 sql，初始化数据库中的数据。</p>
<h4 id="创建-repository"><a class="markdownIt-Anchor" href="#创建-repository"></a> 创建 Repository</h4>
<h5 id="方式一-继承-jparepository-接口-推荐"><a class="markdownIt-Anchor" href="#方式一-继承-jparepository-接口-推荐"></a> 方式一 继承 JpaRepository 接口 (推荐)</h5>
<p>创建包 <code>repository</code> ，创建接口 <code>StudentRepository</code> 继承 <code>JpaRepository&lt;T,ID&gt;</code> ，其中 <code>JpaRepository</code> 需要指定两个泛型约束，T 为 Entity 实体类，ID 为该实体类的主键类型。这个接口包含了很多基本的增删改查方法，可以直接使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.domain.Student;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Student,Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="方式二-使用-repositorydefinition-注解"><a class="markdownIt-Anchor" href="#方式二-使用-repositorydefinition-注解"></a> 方式二 使用 @RepositoryDefinition 注解</h5>
<p>创建接口 <code>TeacherRepository</code> ，添加注解 <code>@RepositoryDefinition</code>，这个注解有两个参数，<code>domainClass</code> 为实体类 class，<code>idClass</code> 为实体类主键的 class。这种方法创建的 Repository 接口中没有方法，需要自己添加。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.domain.Teacher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.RepositoryDefinition;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RepositoryDefinition(domainClass = Teacher.class,idClass = Long.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TeacherRepository</span> &#123;</span><br><span class="line">	Teacher <span class="title function_">findById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建-service"><a class="markdownIt-Anchor" href="#创建-service"></a> 创建 Service</h4>
<p>推荐使用第一种方式创建 Repository ，其从父类继承了一些基本的 CRUD 方法，使用这些方法可以创建一个基础的 Service 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.domain.Student;</span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.repository.StudentRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentRepository studentRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;Student&gt; <span class="title function_">findOne</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> studentRepository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Student&gt;  <span class="title function_">findAll</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> studentRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">save</span><span class="params">(Student student)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> studentRepository.save(student);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">        studentRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建-controller"><a class="markdownIt-Anchor" href="#创建-controller"></a> 创建 Controller</h4>
<p>使用上面创建的 Service 可以创建一个 Controller ，提供 restful 风格的 api 接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.web.rest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.service.StudentService;</span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.domain.Student;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentResource</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentService studentService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加学生</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> student 学生</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 学生id为空时添加存储并返回学生信息，否则不添加，返回错误信息，</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/students&quot;, method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Student&gt; <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> Student student)</span> <span class="keyword">throws</span> URISyntaxException &#123;</span><br><span class="line">        <span class="keyword">if</span> (student.getId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().body(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        student = studentService.save(student);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.created(<span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;/api/students/&quot;</span>+student.getId())).body(student);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改学生信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> student 学生</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 学生 ID 为空时返回错误信息，否则返回修改后的学生信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/students&quot;, method = RequestMethod.PUT, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Student&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> Student student)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (student.getId() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().body(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        student = studentService.save(student);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(student);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除学生信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 学生ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/students/&#123;id&#125;&quot;, method = RequestMethod.DELETE, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        studentService.delete(id);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询一个学生</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 学生 ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 学生信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/students/&#123;id&#125;&quot;, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Student&gt; <span class="title function_">getOne</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        Optional&lt;Student&gt; student = studentService.findOne(id);</span><br><span class="line">        <span class="keyword">return</span> student</span><br><span class="line">                .map(result-&gt;<span class="keyword">new</span> <span class="title class_">ResponseEntity</span>(result, HttpStatus.OK))</span><br><span class="line">                .orElse(<span class="keyword">new</span> <span class="title class_">ResponseEntity</span>(HttpStatus.NOT_FOUND));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有学生</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 所有学生信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/students&quot;, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;Student&gt;&gt; <span class="title function_">getStudents</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Student&gt; students = studentService.findAll();</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(students);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="单元测试"><a class="markdownIt-Anchor" href="#单元测试"></a> 单元测试</h4>
<p>创建一个测试类，用来测试我们 controller 提供的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.web.rest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.JpademoApplication;</span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.domain.Student;</span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.repository.StudentRepository;</span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.service.StudentService;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.mockito.MockitoAnnotations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.web.PageableHandlerMethodArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.util.ReflectionTestUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.setup.MockMvcBuilders;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManager;</span><br><span class="line"><span class="keyword">import</span> javax.transaction.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.time.ZonedDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.assertThat;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.hamcrest.Matchers.hasItem;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/12/13.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wqf31415</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = JpademoApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentResourceTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_NAME</span> <span class="operator">=</span> <span class="string">&quot;ZhangSan&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UPDATED_NAME</span> <span class="operator">=</span> <span class="string">&quot;LiSi&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">DEFAULT_AGE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">UPDATED_AGE</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ZonedDateTime</span> <span class="variable">DEFAULT_BIRTHDAY</span> <span class="operator">=</span> ZonedDateTime.ofInstant(Instant.ofEpochMilli(<span class="number">0L</span>), ZoneId.systemDefault());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ZonedDateTime</span> <span class="variable">UPDATED_BIRTHDAY</span> <span class="operator">=</span> ZonedDateTime.now(ZoneId.systemDefault()).withNano(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_BIRTHDAY_STR</span> <span class="operator">=</span> DateTimeFormatter.ISO_OFFSET_DATE_TIME.format(DEFAULT_BIRTHDAY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">DEFAULT_ACTIVE</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">UPDATED_ACTIVE</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentRepository studentRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentService studentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MappingJackson2HttpMessageConverter mappingJackson2HttpMessageConverter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PageableHandlerMethodArgumentResolver pageableHandlerMethodArgumentResolver;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager em;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MockMvc restStudentMockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Student student;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="built_in">this</span>);</span><br><span class="line">        <span class="type">StudentResource</span> <span class="variable">studentResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StudentResource</span>();</span><br><span class="line">        ReflectionTestUtils.setField(studentResource,<span class="string">&quot;studentService&quot;</span>,studentService);</span><br><span class="line">        <span class="built_in">this</span>.restStudentMockMvc = MockMvcBuilders.standaloneSetup(studentResource)</span><br><span class="line">                .setCustomArgumentResolvers(pageableHandlerMethodArgumentResolver)</span><br><span class="line">                .setMessageConverters(mappingJackson2HttpMessageConverter)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title function_">createEntity</span><span class="params">(EntityManager em)</span>&#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        s.setName(DEFAULT_NAME);</span><br><span class="line">        s.setAge(DEFAULT_AGE);</span><br><span class="line">        s.setBirthday(DEFAULT_BIRTHDAY);</span><br><span class="line">        s.setActive(DEFAULT_ACTIVE);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        student = createEntity(em);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">databaseSizeBeforeCreate</span> <span class="operator">=</span> studentRepository.findAll().size();</span><br><span class="line"></span><br><span class="line">        restStudentMockMvc.perform(post(<span class="string">&quot;/api/students&quot;</span>)</span><br><span class="line">        .contentType(TestUtil.APPLICATION_JSON_UTF8)</span><br><span class="line">        .content(TestUtil.convertObjectToJsonBytes(student)))</span><br><span class="line">        .andExpect(status().isCreated());</span><br><span class="line"></span><br><span class="line">        List&lt;Student&gt; students = studentRepository.findAll();</span><br><span class="line">        assertThat(students).hasSize(databaseSizeBeforeCreate+<span class="number">1</span>);</span><br><span class="line">        <span class="type">Student</span> <span class="variable">testStudent</span> <span class="operator">=</span> students.get(students.size()-<span class="number">1</span>);</span><br><span class="line">        assertThat(testStudent.getName()).isEqualTo(DEFAULT_NAME);</span><br><span class="line">        assertThat(testStudent.getAge()).isEqualTo(DEFAULT_AGE);</span><br><span class="line">        assertThat(testStudent.getBirthday()).isEqualTo(DEFAULT_BIRTHDAY);</span><br><span class="line">        assertThat(testStudent.getActive()).isEqualTo(DEFAULT_ACTIVE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        studentRepository.saveAndFlush(student);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">databaseSizeBeforeUpdate</span> <span class="operator">=</span> studentRepository.findAll().size();</span><br><span class="line"></span><br><span class="line">        <span class="type">Student</span> <span class="variable">updateStudent</span> <span class="operator">=</span> studentRepository.findById(student.getId()).get();</span><br><span class="line">        updateStudent.setName(UPDATED_NAME);</span><br><span class="line">        updateStudent.setAge(UPDATED_AGE);</span><br><span class="line">        updateStudent.setBirthday(UPDATED_BIRTHDAY);</span><br><span class="line">        updateStudent.setActive(UPDATED_ACTIVE);</span><br><span class="line"></span><br><span class="line">        restStudentMockMvc.perform(put(<span class="string">&quot;/api/students&quot;</span>)</span><br><span class="line">                    .contentType(TestUtil.APPLICATION_JSON_UTF8)</span><br><span class="line">                    .content(TestUtil.convertObjectToJsonBytes(updateStudent)))</span><br><span class="line">                .andExpect(status().isOk());</span><br><span class="line"></span><br><span class="line">        List&lt;Student&gt; students = studentRepository.findAll();</span><br><span class="line">        assertThat(students).hasSize(databaseSizeBeforeUpdate);</span><br><span class="line">        <span class="type">Student</span> <span class="variable">testStudent</span> <span class="operator">=</span> students.get(students.size()-<span class="number">1</span>);</span><br><span class="line">        assertThat(testStudent.getName()).isEqualTo(UPDATED_NAME);</span><br><span class="line">        assertThat(testStudent.getAge()).isEqualTo(UPDATED_AGE);</span><br><span class="line">        assertThat(testStudent.getBirthday()).isEqualTo(UPDATED_BIRTHDAY);</span><br><span class="line">        assertThat(testStudent.getActive()).isEqualTo(UPDATED_ACTIVE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteStudent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        studentRepository.saveAndFlush(student);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">databaseSizeBeforeUpdate</span> <span class="operator">=</span> studentRepository.findAll().size();</span><br><span class="line"></span><br><span class="line">        restStudentMockMvc.perform(delete(<span class="string">&quot;/api/students/&#123;id&#125;&quot;</span>,student.getId()).accept(TestUtil.APPLICATION_JSON_UTF8))</span><br><span class="line">                .andExpect(status().isOk());</span><br><span class="line"></span><br><span class="line">        List&lt;Student&gt; students = studentRepository.findAll();</span><br><span class="line"></span><br><span class="line">        assertThat(students).hasSize(databaseSizeBeforeUpdate-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getOne</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        studentRepository.saveAndFlush(student);</span><br><span class="line"></span><br><span class="line">        restStudentMockMvc.perform(get(<span class="string">&quot;/api/students/&#123;id&#125;&quot;</span>,student.getId()))</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andExpect(content().contentType(MediaType.APPLICATION_JSON_UTF8_VALUE))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.id&quot;</span>).value(student.getId().intValue()))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.name&quot;</span>).value(DEFAULT_NAME.toString()))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.age&quot;</span>).value(DEFAULT_AGE.intValue()))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.birthday&quot;</span>).value(DEFAULT_BIRTHDAY_STR))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.active&quot;</span>).value(DEFAULT_ACTIVE.booleanValue()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getNotExistStudent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        restStudentMockMvc.perform(get(<span class="string">&quot;/api/students/&#123;id&#125;&quot;</span>,Long.MAX_VALUE))</span><br><span class="line">                .andExpect(status().isNotFound());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getStudents</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        studentRepository.saveAndFlush(student);</span><br><span class="line"></span><br><span class="line">        restStudentMockMvc.perform(get(<span class="string">&quot;/api/students&quot;</span>))</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andExpect(content().contentType(MediaType.APPLICATION_JSON_UTF8_VALUE))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.[*].id&quot;</span>).value(hasItem(student.getId().intValue())))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.[*].name&quot;</span>).value(hasItem(DEFAULT_NAME)))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.[*].age&quot;</span>).value(hasItem(DEFAULT_AGE.intValue())))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.[*].birthday&quot;</span>).value(hasItem(DEFAULT_BIRTHDAY_STR)))</span><br><span class="line">                .andExpect(jsonPath(<span class="string">&quot;$.[*].active&quot;</span>).value(hasItem(DEFAULT_ACTIVE.booleanValue())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中新添加了一个测试工具类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.web.rest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">MediaType</span> <span class="variable">APPLICATION_JSON_UTF8</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaType</span>(</span><br><span class="line">            MediaType.APPLICATION_JSON.getType(),</span><br><span class="line">            MediaType.APPLICATION_JSON.getSubtype(), Charset.forName(<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] convertObjectToJsonBytes(Object object)</span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class="line"></span><br><span class="line">        <span class="type">JavaTimeModule</span> <span class="variable">module</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaTimeModule</span>();</span><br><span class="line">        mapper.registerModule(<span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mapper.writeValueAsBytes(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] createByteArray(<span class="type">int</span> size, String data) &#123;</span><br><span class="line">        <span class="type">byte</span>[] byteArray = <span class="keyword">new</span> <span class="title class_">byte</span>[size];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            byteArray[i] = Byte.parseByte(data, <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> byteArray;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义查询方法"><a class="markdownIt-Anchor" href="#自定义查询方法"></a> 自定义查询方法</h3>
<h4 id="创建查询方法"><a class="markdownIt-Anchor" href="#创建查询方法"></a> 创建查询方法</h4>
<p>以上创建的 demo 项目，已经可以自动建表，并具有基本的 CRUD 功能接口，并进行了单元测试。在实际项目中，查询需求多种多样，下面我们来看一下，在 spring data jpa 中可以怎么创建独特的查询方法。<br />
<strong>在使用 spring data jpa 时，我们可以在 <code>Repository</code> 中定义一些方法，来实现一些查询功能。</strong><br />
如：我们要查询所有年龄大于 18 岁并且信息激活了的学生信息，只需要在 <code>StudentRepository</code> 中添加一个方法 <code>List&lt;Student&gt; findByAgeGreaterThanAndActiveTrue(int age);</code> ，不需要写任何实现类，就可以在 <code>StudentService</code> 中调用了。</p>
<p>在 Spring Data 中，查询方法以 <strong>find</strong> 或 <strong>read</strong> 或 <strong>get</strong> 开头，后面跟字段名(字段名首字母大写)，再加上限制条件；<br />
JPA 自定义查询方法关键字：</p>
<table>
<thead>
<tr>
<th style="text-align:center">关键词</th>
<th style="text-align:center">方法示例</th>
<th style="text-align:center">JPQL语句</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">And</td>
<td style="text-align:center">findByNameAndAge(String name,int age)</td>
<td style="text-align:center">…where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> = ?1 and x.age = ?2</td>
<td style="text-align:center">并且，注意条件名称与参数的位置与数量要一一对应</td>
</tr>
<tr>
<td style="text-align:center">Or</td>
<td style="text-align:center">findByNameOrAge(String name,int age)</td>
<td style="text-align:center">…where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> = ?1 or x.age = ?2</td>
<td style="text-align:center">或</td>
</tr>
<tr>
<td style="text-align:center">Is,Equals</td>
<td style="text-align:center">findByNameIs(String name),findByNameEquals(String name)</td>
<td style="text-align:center">…where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> = ?1</td>
<td style="text-align:center">等于</td>
</tr>
<tr>
<td style="text-align:center">Between</td>
<td style="text-align:center">findByAgeBetween(int start,int end)</td>
<td style="text-align:center">… where x.age&gt;?1 and x.age &lt; ?2</td>
<td style="text-align:center">两者之间</td>
</tr>
<tr>
<td style="text-align:center">LessThan</td>
<td style="text-align:center">findByAgeLessThan(int age)</td>
<td style="text-align:center">… where x.age &lt; ?1</td>
<td style="text-align:center">小于</td>
</tr>
<tr>
<td style="text-align:center">LessThanEqual</td>
<td style="text-align:center">findByAgeLessThanEqual(int age)</td>
<td style="text-align:center">… where x.age &lt;= ?1</td>
<td style="text-align:center">小于等于</td>
</tr>
<tr>
<td style="text-align:center">GreaterThan</td>
<td style="text-align:center">findByAgeGreaterThan(int age)</td>
<td style="text-align:center">… where x.age &gt; ?1</td>
<td style="text-align:center">大于</td>
</tr>
<tr>
<td style="text-align:center">GreaterThanEqual</td>
<td style="text-align:center">findByAgeGreaterThanEqual(int age)</td>
<td style="text-align:center">… where x.age &gt;= ?1</td>
<td style="text-align:center">大于等于</td>
</tr>
<tr>
<td style="text-align:center">After</td>
<td style="text-align:center">findByBirthdayAfter(String birthday)</td>
<td style="text-align:center">… where x.birthday &gt; ?1</td>
<td style="text-align:center">之后(时间)</td>
</tr>
<tr>
<td style="text-align:center">Before</td>
<td style="text-align:center">findByBirthdayBefore(String birthday)</td>
<td style="text-align:center">… where x.birthday &lt; ?1</td>
<td style="text-align:center">之前(时间)</td>
</tr>
<tr>
<td style="text-align:center">IsNull</td>
<td style="text-align:center">findByAgeIsNull()</td>
<td style="text-align:center">… where x.age is null</td>
<td style="text-align:center">等于 null</td>
</tr>
<tr>
<td style="text-align:center">IsNotNull/NotNull</td>
<td style="text-align:center">findByAgeIsNotNull()/findByAgeNotNull()</td>
<td style="text-align:center">… where x.age is not null</td>
<td style="text-align:center">不等于 null</td>
</tr>
<tr>
<td style="text-align:center">Like</td>
<td style="text-align:center">findByNameLike(String name)</td>
<td style="text-align:center">… where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> like ?1</td>
<td style="text-align:center">模糊查询，查询条件中需要自己加 %</td>
</tr>
<tr>
<td style="text-align:center">NotLike</td>
<td style="text-align:center">findByNameNotLike(String name)</td>
<td style="text-align:center">… where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> not like ?1</td>
<td style="text-align:center">不再模糊范围内，查询条件中需要自己加%</td>
</tr>
<tr>
<td style="text-align:center">StartingWith</td>
<td style="text-align:center">findByNameStartingWith(String name)</td>
<td style="text-align:center">… where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> like ?1</td>
<td style="text-align:center">以某开头，参数后面会添加 %</td>
</tr>
<tr>
<td style="text-align:center">EndingWith</td>
<td style="text-align:center">findByNameEndingWith(String name)</td>
<td style="text-align:center">… where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> like ?!</td>
<td style="text-align:center">以某结尾，参数前会添加 %</td>
</tr>
<tr>
<td style="text-align:center">Containing</td>
<td style="text-align:center">findByNameContaining(String name)</td>
<td style="text-align:center">… where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> like ?1</td>
<td style="text-align:center">包含某，参数前后添加 %</td>
</tr>
<tr>
<td style="text-align:center">OrderBy</td>
<td style="text-align:center">findByAgeOrderByNameDesc(int age)</td>
<td style="text-align:center">… where x.age = ?1 order by <a target="_blank" rel="noopener" href="http://x.name">x.name</a> desc</td>
<td style="text-align:center">排序，Desc 为倒序排列，Asc 为正序排列，默认使用正序排列，所以正序排列可以不显式声明</td>
</tr>
<tr>
<td style="text-align:center">Not</td>
<td style="text-align:center">findByNameNot(String name)</td>
<td style="text-align:center">… where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> != ?!</td>
<td style="text-align:center">不等于</td>
</tr>
<tr>
<td style="text-align:center">In</td>
<td style="text-align:center"><code>findByNameIn(List&lt;String&gt; nameList)</code></td>
<td style="text-align:center">… where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> in ?1</td>
<td style="text-align:center">在某范围内，参数类型为 Collection</td>
</tr>
<tr>
<td style="text-align:center">NotIn</td>
<td style="text-align:center"><code>findByNameNotIn(List&lt;String&gt; nameList)</code></td>
<td style="text-align:center">… where <a target="_blank" rel="noopener" href="http://x.name">x.name</a> not in ?1</td>
<td style="text-align:center">不在某范围内，参数类型为Collection</td>
</tr>
<tr>
<td style="text-align:center">True</td>
<td style="text-align:center">findByActiveTrue()</td>
<td style="text-align:center">… where x.active = true</td>
<td style="text-align:center">真</td>
</tr>
<tr>
<td style="text-align:center">False</td>
<td style="text-align:center">findByActiveFalse()</td>
<td style="text-align:center">… where x.active = false</td>
<td style="text-align:center">假</td>
</tr>
<tr>
<td style="text-align:center">IgnoreCase</td>
<td style="text-align:center">findByNameIgnoreCase(String name)</td>
<td style="text-align:center">… where UPPER(<a target="_blank" rel="noopener" href="http://x.name">x.name</a>) = UPPER(?1)</td>
<td style="text-align:center">忽略大小写</td>
</tr>
</tbody>
</table>
<h4 id="排序与分页"><a class="markdownIt-Anchor" href="#排序与分页"></a> 排序与分页</h4>
<p>可以在上述方法中加入 Sort 或 Pageable 参数，对结果进行排序或分页，如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Student&gt; <span class="title function_">findByAgeGreaterThan</span><span class="params">(<span class="type">int</span> age, Pageable pageable)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="查询方法的解析流程"><a class="markdownIt-Anchor" href="#查询方法的解析流程"></a> 查询方法的解析流程</h4>
<blockquote>
<p>参考：SpringDataJpa：JpaRepository增删改查 - 琦彦 - CSDN博客  <a target="_blank" rel="noopener" href="https://blog.csdn.net/fly910905/article/details/78557110">https://blog.csdn.net/fly910905/article/details/78557110</a></p>
</blockquote>
<ul>
<li>
<p>Spring Data JPA 框架在解析方法名时，首先解析 前缀，如 find、findBy、read、readBy、get、getBy，然后解析剩下的部分，例如 Entity 为 Student，查询方法为 findByParentPhoneNumber</p>
</li>
<li>
<p>首先去除 <code>findBy</code> 前缀后，解析剩下的 <code>ParentPhoneNumber</code> ，将其首字母转成小写，判断是否是实体 Student 的属性，如果是就根据这个属性进行查询，如果不是则进入下一步；</p>
</li>
<li>
<p>从右往左去除 <strong>ParentPhoneNumber</strong> 第一个大写字母开头的字符串，本例中是 <strong>Number</strong>，检查剩下的部分 <strong>ParentPhone</strong> ，首字母转小写后判断是否是 <strong>Student</strong> 的属性，如果是则按该属性进行查询；否则重复此步骤，继续从右往左截取；假设最终 <strong>parent</strong> 是 Student 的一个属性；</p>
</li>
<li>
<p>接着处理剩下的部分（<strong>PhoneNumber</strong>），先判断整体 <strong>phoneNumber</strong> 是否是 <strong>parent</strong> 的属性，如果是则按 <strong>Student.parent.phoneNumber</strong> 进行查询；否则继续从右往左截取判断，最终表示根据 <strong>Student.parent.phone.number</strong> 的值进行查询；</p>
</li>
</ul>
<blockquote>
<p>注意：可能会有一种特殊情况，如在 <strong>Student</strong> 中包含一个 <strong>parent</strong> 属性，也有一个 <strong>parentPhone</strong> 属性，此时就会存在混淆。可以在属性间加上下划线 “<em>” 明确表达意图，如 <code>findByParent_PhoneNumber()</code> 或 <code>findByParentPhone_Number()</code> 。<br />
**强烈建议：无论是否存在混淆，都要在不同类层级之间加上下划线 “</em>” 分隔，增加代码可读性。**</p>
</blockquote>
<h4 id="查询结果限制"><a class="markdownIt-Anchor" href="#查询结果限制"></a> 查询结果限制</h4>
<p>查询第一条记录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Student <span class="title function_">findFirstByAgeLessThanOrderByNameDesc</span><span class="params">(<span class="type">int</span> age)</span>;</span><br><span class="line">Student <span class="title function_">findTopByOrderByAge</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>分页查询排序考前10条记录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Page&lt;Student&gt; <span class="title function_">queryFirst10ByName</span><span class="params">(String name, Pageable pageable)</span>;</span><br><span class="line">Slice&lt;Student&gt; <span class="title function_">findTop10ByLastName</span><span class="params">(String lastName,Pageable <span class="keyword">package</span>)</span>;</span><br><span class="line">List&lt;Student&gt; <span class="title function_">findFirst10ByLastName</span><span class="params">(String lastName, Sort sort)</span>;</span><br><span class="line">List&lt;Student&gt; <span class="title function_">findTop10ByLastName</span><span class="params">(String lastName, Pageable <span class="keyword">package</span>)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="计数查询与删除方法"><a class="markdownIt-Anchor" href="#计数查询与删除方法"></a> 计数查询与删除方法</h4>
<p>计数查询方法以 <strong>countBy</strong> 开头，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">countByAgeLessThan</span><span class="params">(<span class="type">int</span> age)</span>;</span><br></pre></td></tr></table></figure>
<p>删除方法以 <strong>deleteBy</strong> 开头，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">deleteByName</span><span class="params">(String name)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="jpql-查询"><a class="markdownIt-Anchor" href="#jpql-查询"></a> JPQL 查询</h3>
<blockquote>
<p>JPQL 全称 Java Persistence Query Language，即 Java 持久化查询语言，与原生 SQL 语句类似，完全面向对象，通过实体名与属性名访问，不是表名和表的字段名，不支持 INSERT 操作。<br />
**注意：这里用的是实体名，默认为类名，可以在 @Entity 注解中修改实体名，如 @Entity(“tb_student”) 查询时要使用 tb_student **</p>
</blockquote>
<h4 id="jpql-的-select"><a class="markdownIt-Anchor" href="#jpql-的-select"></a> JPQL 的 SELECT</h4>
<p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ... [<span class="keyword">WHERE</span> ...] [<span class="keyword">GROUP</span> <span class="keyword">BY</span> ... [<span class="keyword">HAVING</span> ...]] [<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...] </span><br></pre></td></tr></table></figure>
<p>where 子句条件关键字：</p>
<table>
<thead>
<tr>
<th style="text-align:center">含义</th>
<th style="text-align:center">关键字</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">比较</td>
<td style="text-align:center">=、&gt;、&gt;=、&lt;、&lt;=、&lt;&gt;</td>
</tr>
<tr>
<td style="text-align:center">between</td>
<td style="text-align:center">[not] between</td>
</tr>
<tr>
<td style="text-align:center">模糊匹配</td>
<td style="text-align:center">[not] like</td>
</tr>
<tr>
<td style="text-align:center">包含</td>
<td style="text-align:center">[not] in</td>
</tr>
<tr>
<td style="text-align:center">空</td>
<td style="text-align:center">is [not] null</td>
</tr>
<tr>
<td style="text-align:center">empty</td>
<td style="text-align:center">is [not] empty</td>
</tr>
<tr>
<td style="text-align:center">存在</td>
<td style="text-align:center">[not] exists</td>
</tr>
</tbody>
</table>
<p>在 Spring Data JPA 中使用时，需要在 Repository 接口中的方法上加上 @Query 注解，在注解中申明查询语句。</p>
<p>参数绑定：</p>
<ul>
<li>按参数位置传参，使用 “?X”  ，X 为方法中参数位置，从 1 开始计算，参数的个数与顺序要与方法参数保持一致；</li>
<li>使用参数名传参，使用 “:paramName” 的方式，这种方式不用管参数顺序，paramName 为参数名，参数名需要使用 @Param(“paramName”) 注解指定的名称，而不是方法的参数名称；</li>
<li>使用 SPEL 的取值表达式进行参数绑定；<br />
下面的 UPDATE 和 DELETE 语句中都可以使用这些方式传参。示例：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按参数位置绑定</span></span><br><span class="line">   <span class="meta">@Query(&quot;select student from Student as student where student.birthday between ?1 and ?2&quot;)</span></span><br><span class="line">   List&lt;Student&gt; <span class="title function_">findStudentByBirthdayBetween</span><span class="params">(String startTime,String endTime)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 按参数名绑定</span></span><br><span class="line"><span class="meta">@Query(&quot;select student from Student student where student.age between :startAge and :endAge&quot;)</span></span><br><span class="line">   List&lt;Student&gt; <span class="title function_">findStudentByAgeBetween</span><span class="params">(<span class="meta">@Param(&quot;startAge&quot;)</span> <span class="type">int</span> startAge, <span class="meta">@Param(&quot;endAge&quot;)</span> <span class="type">int</span> endAge)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JPQL查询语句中可以不写 seleect ，从 from 开始写就可以</span></span><br><span class="line">   <span class="meta">@Query(&quot;from Student s where s.name = ?1 and s.age = ?2&quot;)</span></span><br><span class="line">   Student <span class="title function_">findStudentByNameAndAge</span><span class="params">(String name, <span class="type">int</span> age)</span>;	</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模糊查询时要在参数前后添加 “%”</span></span><br><span class="line"><span class="meta">@Query(&quot;select s from Student s where s.name like %?1%&quot;)</span></span><br><span class="line">   List&lt;Student&gt; <span class="title function_">findStudentLikeName</span><span class="params">(String likeName)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数为集合</span></span><br><span class="line"><span class="meta">@Query(&quot;select s from Student s where s.id in ?1&quot;)</span></span><br><span class="line">   List&lt;Student&gt; <span class="title function_">findByStudentIds</span><span class="params">(List&lt;Long&gt; idList)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入Bean进行查询（SPEL表达式查询）</span></span><br><span class="line">   <span class="meta">@Query(value = &quot;from Student s where s.name=:#&#123;#std.name&#125; and s.age=:#&#123;#std.age&#125;&quot;)</span></span><br><span class="line">   Student <span class="title function_">findByNameAndAge</span><span class="params">(<span class="meta">@Param(&quot;std&quot;)</span>Student student)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分页</span></span><br><span class="line">   <span class="meta">@Query(&quot;from Student s&quot;)</span></span><br><span class="line">   Page&lt;Student&gt; <span class="title function_">findAllStudent</span><span class="params">(Pageable pageable)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带查询条件的分页</span></span><br><span class="line">   <span class="meta">@Query(&quot;select s from Student s where s.age &gt;?1&quot;)</span></span><br><span class="line">   Page&lt;Student&gt; <span class="title function_">findStudentAgeGreaterThan</span><span class="params">(<span class="type">int</span> age, Pageable pageable)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意语句中使用的都是实体名和属性名，不是表名和表中字段名。</p>
</blockquote>
<p>查询结果分页，可以在查询方法中加入 Pageable pageable 参数，即可对查询结果进行分页。</p>
<h4 id="jpql-的-update"><a class="markdownIt-Anchor" href="#jpql-的-update"></a> JPQL 的 UPDATE</h4>
<p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> ... <span class="keyword">SET</span> ... [<span class="keyword">WHERE</span> ...]</span><br></pre></td></tr></table></figure>
<p><strong>温馨提示：在使用时需要添加 @Modified 和 @Query 注解，在调用的 Service 方法上要添加 @Transaction 注解，否则会报缺少事务控制的错。</strong><br />
示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query(&quot;update Student s set s.age = ?1 where name = ?2&quot;)</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">modifyStudentAgeByName</span><span class="params">(<span class="type">int</span> age, String name)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="jpql-的-delete"><a class="markdownIt-Anchor" href="#jpql-的-delete"></a> JPQL 的 DELETE</h4>
<p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> ... [<span class="keyword">WHERE</span> ...]</span><br></pre></td></tr></table></figure>
<p><strong>与 UPDATE 的使用方式相同，也需要添加 @Modified 和 @Query 注解，在调用的 Service 方法上要添加 @Transaction 注解，否则会报错。</strong><br />
示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query(&quot;delete from Student s where s.name = ?1&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteStudentByName</span><span class="params">(String name)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="联合查询"><a class="markdownIt-Anchor" href="#联合查询"></a> 联合查询</h4>
<p>在 JPQL 中可以使用 <strong>join</strong> 、<strong>left join</strong> 、<strong>right join</strong> 进行联表查询，用法与原生 sql 相同。<br />
示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(value = &quot;SELECT d FROM Device d JOIN d.pole p JOIN p.circuit c WHERE c.id = :circuitId AND d.hidden = 0&quot;)</span></span><br><span class="line">List&lt;Device&gt; <span class="title function_">findDevicesByGivenCircuitId</span><span class="params">(<span class="meta">@Param(&quot;circuitId&quot;)</span> Long circuitId)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="关联查询与部分字段映射投影"><a class="markdownIt-Anchor" href="#关联查询与部分字段映射投影"></a> 关联查询与部分字段映射投影</h4>
<p>当需要从多张表或一张字段很多的表中查询，但结果只需要一部分字段数据时，就需要用到投影了。<br />
第一种方法，使用 VM （View Module）<br />
查询两张表，取部分字段组成新的对象，如取 Student 的 id、name、age字段，取 Classes 的 name 字段，组成 StudentVM 对象，可以分页查询，需要创建 StudentVM 类，并创建包含所需字段的构造方法。<br />
查询方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询结果转VM</span></span><br><span class="line">   <span class="meta">@Query(&quot;select new com.example.jpademo.web.rest.vm.StudentVM(s.id,s.name,s.age,c.name as className) from Student s left join s.classes c&quot;)</span></span><br><span class="line">   Page&lt;StudentVM&gt; <span class="title function_">findStudentAndClass</span><span class="params">(Pageable pageable)</span>;</span><br></pre></td></tr></table></figure>
<p>StudentVM 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.web.rest.vm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentVM</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String classsName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StudentVM</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 一定要有这个构造方法，在查询方法中使用时须注意参数的位置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StudentVM</span><span class="params">(Long id, String name, Integer age, String classsName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.classsName = classsName;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 为了节约篇幅，省略 setter、getter、toString 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二种方法，使用 projection 接口。<br />
创建 StudentProjection 接口，添加需要字段的 getXXX 方法，其中 XXX 要与查询语句中的别名对应，不一致时可以使用 <code>@Value</code> 注解调整，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.web.rest.vm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentProjection</span> &#123;</span><br><span class="line"></span><br><span class="line">    Long <span class="title function_">getId</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">getAge</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当别名与 getXXX 名称不一致时，可以使用 @Value 注解调整，target 不能省略，className 是在查询语句中设定的别名</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;target.className&#125;&quot;)</span></span><br><span class="line">    String <span class="title function_">getCname</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Repository 中添加查询方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// projection 投影映射</span></span><br><span class="line"><span class="meta">@Query(&quot;select s.id as id, s.name as name, s.age as age, c.name as className from tb_student s left join s.classes c &quot;)</span></span><br><span class="line">Page&lt;Student&gt; <span class="title function_">findAllStudentAndClass</span><span class="params">(Pageable pageable)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="jpql-命名查询"><a class="markdownIt-Anchor" href="#jpql-命名查询"></a> JPQL 命名查询</h4>
<p>命名查询的查询语句会在加载类的时候就生成，在后续的查询中直接使用，可以提高后续的查询速度。<br />
定义命名查询时，需要在实体类上添加 @NamedQueries 注解，只有一个参数，接收 @NamedQuery 注解的数组；@NamedQuery 注解主要两个参数，一个是查询名称 name，命名方式为 <code>实体名.查询方法名</code> ，查询方法名为 Repository 中的查询名，另一个参数为查询语句 query。<br />
实体类例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@NamedQueries(&#123;</span></span><br><span class="line"><span class="meta">				@NamedQuery(name = &quot;Classes.findClassById&quot;,query = &quot;select c from Classes c where c.id = ?1&quot;),</span></span><br><span class="line"><span class="meta">				@NamedQuery(name=&quot;Classes.findAllPage&quot;,query = &quot;select c from Classes c&quot;)</span></span><br><span class="line"><span class="meta">				&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Classes</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">	<span class="comment">// 为了节约篇幅，省略 setter、getter、toString 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的 Repository 为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpademo.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.jpademo.domain.Classes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClassesRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Classes,Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">    Classes <span class="title function_">findClassById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    Page&lt;Classes&gt; <span class="title function_">findAllPage</span><span class="params">(Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="jpql-函数"><a class="markdownIt-Anchor" href="#jpql-函数"></a> JPQL 函数</h4>
<p>JPQL 中提供了一些内嵌的函数，可以处理字符串、计算和日期。</p>
<ul>
<li>字符串处理函数</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">函数</th>
<th style="text-align:center">功能</th>
<th style="text-align:center">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">concat(String s1, String s2)</td>
<td style="text-align:center">连接两个字符串</td>
<td style="text-align:center">concat(&quot;hello &quot;,“world”) —&gt; “hello world”</td>
</tr>
<tr>
<td style="text-align:center">substring(String s, int start, int length)</td>
<td style="text-align:center">截取字符串</td>
<td style="text-align:center">substring(“hello”,1,3) —&gt; “ell”</td>
</tr>
<tr>
<td style="text-align:center">trim([leading</td>
<td style="text-align:center">trailing</td>
<td style="text-align:center">both,][char c,] String s)</td>
</tr>
<tr>
<td style="text-align:center">lower(String s)</td>
<td style="text-align:center">转成小写</td>
<td style="text-align:center">lower(“HeLLo”) —&gt; “hello”</td>
</tr>
<tr>
<td style="text-align:center">upper(String s)</td>
<td style="text-align:center">转成大写</td>
<td style="text-align:center">lower(“HeLLo”) —&gt; “HELLO”</td>
</tr>
<tr>
<td style="text-align:center">length(String s)</td>
<td style="text-align:center">求字符串长度</td>
<td style="text-align:center">length(“hello”) —&gt; 5</td>
</tr>
<tr>
<td style="text-align:center">locate(String s1, String s2[, int start])</td>
<td style="text-align:center">从 s1 中查找 s2 出现的位置，没有返回0</td>
<td style="text-align:center">locate(“hello”,l) —&gt; 2</td>
</tr>
</tbody>
</table>
<ul>
<li>算术函数</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">函数</th>
<th style="text-align:center">功能</th>
<th style="text-align:center">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">abs(x)</td>
<td style="text-align:center">取绝对值</td>
<td style="text-align:center">abs(-1) —&gt; 1</td>
</tr>
<tr>
<td style="text-align:center">mod(int x, int y)</td>
<td style="text-align:center">取模，即 x/y 的余数</td>
<td style="text-align:center">mod(10,4) —&gt; 2</td>
</tr>
<tr>
<td style="text-align:center">sqrt(x)</td>
<td style="text-align:center">取平方根值</td>
<td style="text-align:center">sqrt(25) —&gt; 5</td>
</tr>
</tbody>
</table>
<ul>
<li>日期函数</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">函数</th>
<th style="text-align:center">功能</th>
<th style="text-align:center">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">current_date()</td>
<td style="text-align:center">取当前日期</td>
<td style="text-align:center">current_date() —&gt; 2019-01-15</td>
</tr>
<tr>
<td style="text-align:center">current_time()</td>
<td style="text-align:center">取当前时间</td>
<td style="text-align:center">current_time() —&gt; 15:54:45</td>
</tr>
<tr>
<td style="text-align:center">current_timestamp()</td>
<td style="text-align:center">取当前时间戳</td>
<td style="text-align:center">current_timestamp() —&gt; 2019-01-15 15:54:45</td>
</tr>
</tbody>
</table>
<h3 id="原生查询"><a class="markdownIt-Anchor" href="#原生查询"></a> 原生查询</h3>
<h4 id="简单的原生查询"><a class="markdownIt-Anchor" href="#简单的原生查询"></a> 简单的原生查询</h4>
<p>使用原生的 sql 语句进行查询，在一些复杂的，或 JPQL 无法实现的情况下可以使用。需要添加 @Query 注解，在 value 参数中声明使用的 sql 语句，nativeQuery 参数设置为 true 。<br />
原生查询时传参方式与 JPQL 一致。<br />
示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Query(value = &quot;select s.* from tb_student s where s.active = 1 and s.age = :age&quot;,nativeQuery = true)</span></span><br><span class="line">   List&lt;Student&gt; <span class="title function_">findActiveStudentByAge</span><span class="params">(<span class="meta">@Param(&quot;age&quot;)</span> <span class="type">int</span> age)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Query(value = &quot;select count(id) from tb_student where age = ?1&quot;,nativeQuery = true)</span></span><br><span class="line">   <span class="type">long</span> <span class="title function_">countStudentByAge</span><span class="params">(<span class="type">int</span> age)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以实现增删改查各种操作</span></span><br></pre></td></tr></table></figure>
<h4 id="分页的原生查询"><a class="markdownIt-Anchor" href="#分页的原生查询"></a> 分页的原生查询</h4>
<p>需要分页查询时，需要传 Pageable pageable 参数，在 @Query 注解中声明 countQuery，值为统计查询结果数量的 sql 语句。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(value = &quot;select s.* from tb_student s where s.active = 1&quot;,countQuery = &quot;select count(s.id) from tb_student s where s.active = 1&quot;,nativeQuery = true)</span></span><br><span class="line">Page&lt;Student&gt; <span class="title function_">findActiveStudentPage</span><span class="params">(Pageable pageable)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="联表的原生查询"><a class="markdownIt-Anchor" href="#联表的原生查询"></a> 联表的原生查询</h4>
<p>使用原生 sql 进行联表查询后，不能自动封装成对象，查询结果返回的类型是 Object，多个结果则返回 <code>List&lt;Object&gt;</code> 或 <code>Page&lt;Object&gt;</code> ，其中的每一个 Object 实际是一个 Object 数组，数组每个元素则是查询的字段值，查询完成后需要自己转换成对象。<br />
举个例子，查询 Student 中的 id、name、age 与 Classes 中的 name ，查询方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(value = &quot;SELECT s.id,s.name,s.age,c.name FROM tb_student s LEFT JOIN classes c ON s.classes_id = c.id&quot;,nativeQuery = true)</span></span><br><span class="line">List&lt;Object&gt; <span class="title function_">findStudentInfo</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>在 Service 中调用查询方法，转成需要的对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> List&lt;StudentVM&gt; <span class="title function_">findStudentInfo</span><span class="params">()</span>&#123;</span><br><span class="line">     List&lt;Object&gt; list = studentRepository.findStudentInfo();</span><br><span class="line">     <span class="keyword">return</span> list.stream()</span><br><span class="line">.map(o-&gt;&#123;</span><br><span class="line">	<span class="type">StudentVM</span> <span class="variable">vm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StudentVM</span>();</span><br><span class="line">	<span class="comment">// 将结果对象强转成对象数组</span></span><br><span class="line">	Object[] os = (Object[]) o;</span><br><span class="line">	<span class="comment">// 对象数组里每个元素对应查询语句中的字段，将其取出封装到需要的对象中</span></span><br><span class="line">	<span class="comment">// 注意：有些字段查出结果可能为空，最后是先进行判断</span></span><br><span class="line">	vm.setId((Long) os[<span class="number">0</span>]);</span><br><span class="line">	vm.setName(os[<span class="number">1</span>].toString());</span><br><span class="line">	vm.setAge((<span class="type">int</span>) os[<span class="number">2</span>]);</span><br><span class="line">	vm.setClasssName(os[<span class="number">3</span>].toString());</span><br><span class="line">	<span class="keyword">return</span> vm;</span><br><span class="line">&#125;).collect(Collectors.toList());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>分享一下，下面是我写过最复杂的原生查询方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询给定时间和id列表的设备上下线记录，包括上下线时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deviceIdList</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startTime</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endTime</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Query(value = &quot;select t.* from (SELECT o.device_id,o.device_code,&quot; +</span></span><br><span class="line"><span class="meta">    &quot;SUM(CASE WHEN o.state = &#x27;offline&#x27; THEN 1 ELSE 0 END) offline_count,&quot; +</span></span><br><span class="line"><span class="meta">    &quot;SUM(CASE WHEN o.state = &#x27;Online&#x27; THEN 1 ELSE 0 END) online_count,&quot; +</span></span><br><span class="line"><span class="meta">    &quot;MAX(CASE WHEN o.state = &#x27;offline&#x27; THEN o.time_span END) longest_offline_time &quot; +</span></span><br><span class="line"><span class="meta">    &quot;FROM &quot; +</span></span><br><span class="line"><span class="meta">    &quot;(&quot; +</span></span><br><span class="line"><span class="meta">    &quot;SELECT A.device_id,A.device_code,A.state,A.collection_time,&quot; +</span></span><br><span class="line"><span class="meta">    &quot;timestampdiff(SECOND,A.collection_time,B.collection_time) time_span &quot; +</span></span><br><span class="line"><span class="meta">    &quot;FROM &quot; +</span></span><br><span class="line"><span class="meta">    &quot;(&quot; +</span></span><br><span class="line"><span class="meta">    &quot;SELECT ds.*,(@i \\:= @i + 1) as ord_num &quot; +</span></span><br><span class="line"><span class="meta">    &quot;FROM device_state ds,(select @i \\:= 1) d &quot; +</span></span><br><span class="line"><span class="meta">    &quot;WHERE ds.device_id IN ?#&#123;#deviceIdList&#125; &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND ds.hidden = 0 &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND ds.collection_time BETWEEN ?#&#123;#startTime&#125; AND ?#&#123;#endTime&#125; &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND NOT ISNULL(ds.device_code) &quot; +</span></span><br><span class="line"><span class="meta">    &quot;ORDER BY ds.device_code,ds.collection_time ASC &quot; +</span></span><br><span class="line"><span class="meta">    &quot;)&quot; +</span></span><br><span class="line"><span class="meta">    &quot;as A LEFT JOIN &quot; +</span></span><br><span class="line"><span class="meta">    &quot;(&quot; +</span></span><br><span class="line"><span class="meta">    &quot;SELECT ds.*,(@j \\:= @j + 1) as ord_num &quot; +</span></span><br><span class="line"><span class="meta">    &quot;FROM device_state ds,(select @j \\:= 0) d &quot; +</span></span><br><span class="line"><span class="meta">    &quot;WHERE ds.device_id IN ?#&#123;#deviceIdList&#125; &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND ds.hidden = 0 &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND ds.collection_time BETWEEN ?#&#123;#startTime&#125; AND ?#&#123;#endTime&#125; &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND NOT ISNULL(ds.device_code) &quot; +</span></span><br><span class="line"><span class="meta">    &quot;ORDER BY ds.device_code,ds.collection_time ASC &quot; +</span></span><br><span class="line"><span class="meta">    &quot;) &quot; +</span></span><br><span class="line"><span class="meta">    &quot;as B on A.ord_num = B.ord_num and A.device_code=B.device_code &quot; +</span></span><br><span class="line"><span class="meta">    &quot;) o &quot; +</span></span><br><span class="line"><span class="meta">    &quot;GROUP BY o.device_code &quot;+</span></span><br><span class="line"><span class="meta">    &quot;ORDER BY ?#&#123;#pageable&#125; ) t order by longest_offline_time DESC &quot;,</span></span><br><span class="line"><span class="meta">    countQuery = &quot;select count(*) &quot;+</span></span><br><span class="line"><span class="meta">    &quot;FROM (&quot;+</span></span><br><span class="line"><span class="meta">    &quot;SELECT ds.* FROM device_state ds &quot; +</span></span><br><span class="line"><span class="meta">    &quot;WHERE ds.device_id IN ?#&#123;#deviceIdList&#125; &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND ds.hidden = 0 &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND ds.collection_time BETWEEN ?#&#123;#startTime&#125; AND ?#&#123;#endTime&#125; &quot; +</span></span><br><span class="line"><span class="meta">    &quot;AND NOT ISNULL(ds.device_code) &quot; +</span></span><br><span class="line"><span class="meta">    &quot;GROUP BY ds.device_code) o&quot;,</span></span><br><span class="line"><span class="meta">    nativeQuery = true)</span></span><br><span class="line">Page&lt;Object&gt; <span class="title function_">countDeviceStateByGivenDeviceIdsAndCollectionTime</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Param(&quot;deviceIdList&quot;)</span> List&lt;Long&gt; deviceIdList,</span></span><br><span class="line"><span class="params">    <span class="meta">@Param(&quot;startTime&quot;)</span> String startTime,</span></span><br><span class="line"><span class="params">    <span class="meta">@Param(&quot;endTime&quot;)</span> String endTime,</span></span><br><span class="line"><span class="params">    Pageable pageable</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="specification-查询"><a class="markdownIt-Anchor" href="#specification-查询"></a> Specification 查询</h3>
<p>以上的查询方法使用的查询语句都是固定的，使用起来有时会不灵活，在 Spring Data JPA 中可以使用 Specification 接口实现动态 sql 查询。</p>
<p>使用 Specification 需要让 Repository 接口继承 <code>JpaSpecificationExecutor&lt;T&gt;</code> 接口，这个接口需要指定的泛型类型是当前 Repository 对应的实体类型。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Student,Long&gt;,JpaSpecificationExecutor&lt;Student&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看 Specification 接口源码，发现其中有 5 个查询方法，有查单条记录的，查列表的，可以分页、排序，所有方法都接收一个 Specification 类型的参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.data.jpa.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.domain.Specification;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface to allow execution of &#123;<span class="doctag">@link</span> Specification&#125;s based on the JPA criteria API.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Oliver Gierke</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Christoph Strobl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JpaSpecificationExecutor</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a single entity matching the given &#123;<span class="doctag">@link</span> Specification&#125; or &#123;<span class="doctag">@link</span> Optional#empty()&#125; if none found.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> never &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> org.springframework.dao.IncorrectResultSizeDataAccessException if more than one entity found.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Optional&lt;T&gt; <span class="title function_">findOne</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Specification&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> never &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;T&gt; <span class="title function_">findAll</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a &#123;<span class="doctag">@link</span> Page&#125; of entities matching the given &#123;<span class="doctag">@link</span> Specification&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> pageable must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> never &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Page&lt;T&gt; <span class="title function_">findAll</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec, Pageable pageable)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns all entities matching the given &#123;<span class="doctag">@link</span> Specification&#125; and &#123;<span class="doctag">@link</span> Sort&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sort must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> never &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;T&gt; <span class="title function_">findAll</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec, Sort sort)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the number of instances that the given &#123;<span class="doctag">@link</span> Specification&#125; will return.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spec the &#123;<span class="doctag">@link</span> Specification&#125; to count instances for. Can be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the number of instances.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">long</span> <span class="title function_">count</span><span class="params">(<span class="meta">@Nullable</span> Specification&lt;T&gt; spec)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Specification 是一个接口，我们需要自己创建实现类，在下例中为了演示方便，直接创建的匿名类。在这个接口中有 3 个参数：</p>
<ul>
<li><code>Root&lt;T&gt;</code> 指定查询的实体类型，</li>
<li><code>CriteriaQuery&lt;?&gt;</code> 定义高级查询功能，</li>
<li><code>CriteriaBuilder</code> 用于创建标准查询、联合查询、表达式、条件、排序。</li>
</ul>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Student&gt; <span class="title function_">findStudentByCondition</span><span class="params">(String nameLike, Integer startAge, Integer endAge, ZonedDateTime startBirthday, ZonedDateTime endBirthday, Long classId)</span>&#123;</span><br><span class="line">        Specification&lt;Student&gt; spec = <span class="keyword">new</span> <span class="title class_">Specification</span>&lt;Student&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Predicate <span class="title function_">toPredicate</span><span class="params">(Root&lt;Student&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder criteriaBuilder)</span> &#123;</span><br><span class="line">                List&lt;Predicate&gt; predicates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                predicates.add(criteriaBuilder.like(root.get(<span class="string">&quot;name&quot;</span>),<span class="string">&quot;%&quot;</span>+nameLike+<span class="string">&quot;%&quot;</span>));</span><br><span class="line">                <span class="comment">// 参数不为空时添加查询条件</span></span><br><span class="line">                <span class="keyword">if</span> (startAge != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="comment">// 大于</span></span><br><span class="line">                    predicates.add(criteriaBuilder.greaterThan(root.get(<span class="string">&quot;age&quot;</span>),startAge));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (endAge != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="comment">// 小于</span></span><br><span class="line">                    predicates.add(criteriaBuilder.le(root.get(<span class="string">&quot;age&quot;</span>), endAge));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (startBirthday != <span class="literal">null</span> &amp;&amp; endBirthday != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="comment">// between</span></span><br><span class="line">                    predicates.add(criteriaBuilder.between(root.get(<span class="string">&quot;birthday&quot;</span>), startBirthday, endBirthday));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> criteriaBuilder.and(predicates.toArray(<span class="keyword">new</span> <span class="title class_">Predicate</span>[predicates.size()]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 其他查询条件</span></span><br><span class="line">        Specification&lt;Student&gt; spec2 = ((root, query, criteriaBuilder) -&gt; &#123;</span><br><span class="line">            List&lt;Predicate&gt; predicates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (classId != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// 带关联关系的查询条件</span></span><br><span class="line">                predicates.add(criteriaBuilder.equal(root.get(<span class="string">&quot;classes&quot;</span>).get(<span class="string">&quot;id&quot;</span>),classId));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> criteriaBuilder.and(predicates.toArray(<span class="keyword">new</span> <span class="title class_">Predicate</span>[predicates.size()]));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 多个 Specification 可以用 and 或 or 连接使用</span></span><br><span class="line">        <span class="keyword">return</span> studentRepository.findAll(Specification.where(spec).and(spec2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多数据源"><a class="markdownIt-Anchor" href="#多数据源"></a> 多数据源</h3>
<h4 id="相同数据库"><a class="markdownIt-Anchor" href="#相同数据库"></a> 相同数据库</h4>
<h5 id="配置多数据源"><a class="markdownIt-Anchor" href="#配置多数据源"></a> 配置多数据源</h5>
<p>修改配置文件，添加多个数据源的配置信息。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8989</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">JpaDemo</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 主数据源</span></span><br><span class="line"><span class="attr">spring.datasource.primary.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.primary.jdbc-url</span>=<span class="string">jdbc:mysql://172.16.19.233:3306/testjpa?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="attr">spring.datasource.primary.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.primary.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 第二数据源</span></span><br><span class="line"><span class="attr">spring.datasource.secondary.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.secondary.jdbc-url</span>=<span class="string">jdbc:mysql://172.16.19.229:3306/u_testjpa?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="attr">spring.datasource.secondary.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.secondary.password</span>=<span class="string">root</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 自动建表</span></span><br><span class="line"><span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">create</span></span><br><span class="line"><span class="comment"># 打印 sql 语句</span></span><br><span class="line"><span class="attr">spring.jpa.show-sql</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#不加这句则默认为 MyISAM 引擎，加上之后使用 InnoDB 引擎</span></span><br><span class="line"><span class="attr">spring.jpa.database-platform</span>=<span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.data.elasticsearch.cluster-name</span>=<span class="string">my-application</span></span><br><span class="line"><span class="attr">spring.data.elasticsearch.cluster-nodes</span>=<span class="string">127.0.0.1:9300</span></span><br></pre></td></tr></table></figure>
<p>添加数据源配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(&quot;primaryDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;primaryDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.primary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">primaryDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;secondaryDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;secondaryDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.secondary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">secondaryDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主数据源:</p>
<blockquote>
<p><code>@EnableJpaRepositories</code> 注解参数说明：</p>
<ul>
<li><em>entityManagerFactoryRef</em> → 配置的连接工厂</li>
<li><em>transactionManagerRef</em> → 事务管理器</li>
<li><em>basePackages</em> → 扫描 Repository 的包</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.orm.jpa.HibernateSettings;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.orm.jpa.JpaProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.orm.jpa.EntityManagerFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManager;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(entityManagerFactoryRef = &quot;entityManagerFactoryPrimary&quot;,</span></span><br><span class="line"><span class="meta">	transactionManagerRef = &quot;transactionManagerPrimary&quot;,</span></span><br><span class="line"><span class="meta">	basePackages = &#123;&quot;com.example.jpademo.repository&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrimaryConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;primaryDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> DataSource primaryDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JpaProperties jpaProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;entityManagerPrimary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> EntityManager <span class="title function_">entityManager</span><span class="params">(EntityManagerFactoryBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> entityManagerFactoryPrimary(builder).getObject().createEntityManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;entityManagerFactoryPrimary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">entityManagerFactoryPrimary</span> <span class="params">(EntityManagerFactoryBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder</span><br><span class="line">                .dataSource(primaryDataSource)</span><br><span class="line">                .properties(getVendorProperties(primaryDataSource))</span><br><span class="line">                .packages(<span class="string">&quot;com.example.jpademo.domain&quot;</span>) <span class="comment">//设置实体类所在位置</span></span><br><span class="line">                .persistenceUnit(<span class="string">&quot;primaryPersistenceUnit&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map <span class="title function_">getVendorProperties</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">HibernateSettings</span> <span class="variable">hibernateSettings</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HibernateSettings</span>();</span><br><span class="line">        <span class="keyword">return</span> jpaProperties.getHibernateProperties(hibernateSettings);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManagerPrimary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">transactionManagerPrimary</span><span class="params">(EntityManagerFactoryBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JpaTransactionManager</span>(entityManagerFactoryPrimary(builder).getObject());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二数据源:</p>
<p>与主数据源相似，只是除掉了 <code>@Primary</code> 注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.orm.jpa.HibernateSettings;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.orm.jpa.JpaProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.orm.jpa.EntityManagerFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManager;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(entityManagerFactoryRef = &quot;entityManagerFactorySecondary&quot;,</span></span><br><span class="line"><span class="meta">    transactionManagerRef = &quot;transactionManagerSecondary&quot;,</span></span><br><span class="line"><span class="meta">    basePackages = &#123;&quot;com.example.jpademo.repository2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondaryConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;secondaryDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> DataSource secondaryDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JpaProperties jpaProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;entityManagerSecondary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> EntityManager <span class="title function_">entityManager</span><span class="params">(EntityManagerFactoryBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> entityManagerFactorySecondary(builder).getObject().createEntityManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;entityManagerFactorySecondary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">entityManagerFactorySecondary</span> <span class="params">(EntityManagerFactoryBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder</span><br><span class="line">                .dataSource(secondaryDataSource)</span><br><span class="line">                .properties(getVendorProperties(secondaryDataSource))</span><br><span class="line">                .packages(<span class="string">&quot;com.example.jpademo.domain2&quot;</span>) <span class="comment">//设置实体类所在位置</span></span><br><span class="line">                .persistenceUnit(<span class="string">&quot;secondaryPersistenceUnit&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map <span class="title function_">getVendorProperties</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">HibernateSettings</span> <span class="variable">hibernateSettings</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HibernateSettings</span>();</span><br><span class="line">        <span class="keyword">return</span> jpaProperties.getHibernateProperties(hibernateSettings);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;transactionManagerSecondary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">transactionManagerPrimary</span><span class="params">(EntityManagerFactoryBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JpaTransactionManager</span>(entityManagerFactorySecondary(builder).getObject());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="将不同数据域的实体类-repository-放到不同包下"><a class="markdownIt-Anchor" href="#将不同数据域的实体类-repository-放到不同包下"></a> 将不同数据域的实体类、Repository 放到不同包下</h5>
<p>如上面配置类中配置的，分别将不同数据实体类放到 <code>com.example.jpademo.domain</code> 和 <code>com.example.jpademo.domain2</code> 包中，将对应的 Repository 分别放到 <code>com.example.jpademo.repository</code> 和 <code>com.example.jpademo.repository2</code> 包中。</p>
<h5 id="编写服务类与接口进行测试"><a class="markdownIt-Anchor" href="#编写服务类与接口进行测试"></a> 编写服务类与接口进行测试</h5>
<p>剩下的 Service 类和 Controller 跟正常的没有差别了，这里不再赘述。</p>
<h4 id="不同数据库"><a class="markdownIt-Anchor" href="#不同数据库"></a> 不同数据库</h4>
<p>如在我的项目中要使用到关系型数据库 MySql 和全文检索 Elasticsearch（简称ES） ，可以在存入 MySql 中的实体类上添加 <code>@Entity</code> 注解，在需要存入 ES 的实体上添加 <code>@Document</code> 注解，如果两边都要存，可以同时添加两个注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存入 MySql 的数据实体</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存入 ES 的数据实体</span></span><br><span class="line"><span class="meta">@Document</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两个数据库都要存入的数据</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Document</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Author</span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建对应的 Repository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存入 MySql 的数据实体仓库</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;User, Long&gt;&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存入 ES 的数据实体仓库</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookSearchRepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;Book, String&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jpa-的缺点"><a class="markdownIt-Anchor" href="#jpa-的缺点"></a> JPA 的缺点</h3>
<ul>
<li>联表查询不方便，两个没有关联的表做 join 操作比较繁琐。</li>
<li>框架定制重，不便优化 sql 查询，不如 mybatis 自由度高。</li>
</ul>
<h3 id="注意事项"><a class="markdownIt-Anchor" href="#注意事项"></a> 注意事项</h3>
<h4 id="jpa-是一套标准"><a class="markdownIt-Anchor" href="#jpa-是一套标准"></a> JPA 是一套标准</h4>
<p>在概念上要理解 JPA 是一套标准，而不是具体实现。</p>
<h4 id="驱动错误"><a class="markdownIt-Anchor" href="#驱动错误"></a> 驱动错误</h4>
<p>使用 spring-data-jpa 2.x 版本时，报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loading class &#x27;com.mysql.jdbc.Driver&#x27;. This is deprecated. The new driver class is &#x27;com.mysql.cj.jdbc.Driver&#x27;. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.</span><br></pre></td></tr></table></figure>
<p>原因是： <code>com.mysql.jdbc.Driver</code> 已经弃用了，现在使用 <code>com.mysql.cj.jdbc.Driver</code> ，是通过 SPI 自动注册的，不需要手动加载驱动类。<br />
修改方法：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将配置文件中的 jdbc 驱动改成现在用的这个</span></span><br><span class="line"><span class="attr">com.mysql.jdbc.Driver</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>
<h4 id="时区错误"><a class="markdownIt-Anchor" href="#时区错误"></a> 时区错误</h4>
<p>使用 spring-data-jpa 2.x 版本时，报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.sql.SQLException: The server time zone value &#x27;ÖÐ¹ú±ê×¼Ê±¼ä&#x27; is unrecognized or represents more than one time</span><br></pre></td></tr></table></figure>
<p>原因是：检测到数据库使用的时区不对，mysql默认的是美国的时区，而我们中国大陆要比他们迟8小时，采用+8:00格式。<br />
修改方法：</p>
<ul>
<li>
<p>方法一: 修改数据库时区配置；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 以 root 用户登录 mysql 数据库，运行以下命令</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> time_zone<span class="operator">=</span><span class="string">&#x27;+8:00&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看是否修改成功： </span></span><br><span class="line"><span class="comment">-- show variables like &#x27;%time_zone%&#x27;;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>或者修改 mysql 配置文件：</p>
<blockquote>
<p>配置文件位置：C:\Program Files\MySQL\MySQL Server 5.7\my.ini<br />
修改 [mysqld] 下的 default-time-zone 配置为 ‘+08:00’</p>
</blockquote>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">default-time-zone</span>=<span class="string">&#x27;+08:00&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>方法二: 修改配置文件中的url，添加时区参数；</li>
</ul>
<blockquote>
<p>在 url 中添加当前系统时区参数, <code>GMT%2B8</code> 代表： 东八区(GMT+8)</p>
</blockquote>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8</span></span><br></pre></td></tr></table></figure>
<h4 id="实体匹配错误"><a class="markdownIt-Anchor" href="#实体匹配错误"></a> 实体匹配错误</h4>
<p>在 Repository 查询方法中使用 JPQL 时，项目启动报错<br />
查询方法为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query(&quot;DELETE FROM Student s WHERE s.name = ?1&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteStudentByName</span><span class="params">(String name)</span>;</span><br></pre></td></tr></table></figure>
<p>错误日志主要内容如下：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#x27;studentService&#x27;: Unsatisfied dependency expressed through field &#x27;studentRepository&#x27;; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#x27;studentRepository&#x27;: Invocation of init method failed; nested exception is java.lang.IllegalArgumentException: Validation failed for query for method public abstract void com.example.jpademo.repository.StudentRepository.deleteStudentByName(java.lang.String)!</span><br><span class="line">...</span><br><span class="line">Caused by: java.lang.IllegalArgumentException: org.hibernate.hql.internal.ast.QuerySyntaxException: Student is not mapped [DELETE FROM Student s WHERE s.name = ?1]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>错误的意思是 Student 实体不能匹配，这时首先需要检查实体的属性名和查询语句中的是否对应；如果能够对应，再检查实体类，是否在 @Entity 注解中指定了名称，例如注解为 <code>@Entity(&quot;tb_student&quot;)</code> ，则在 JPQL 查询语句中要使用 tb_student ，而不能使用 Student，正确的查询方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query(&quot;DELETE FROM tb_student s WHERE s.name = ?1&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteStudentByName</span><span class="params">(String name)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="原生-sql-进行分页查询时报错提示不能使用排序和分页"><a class="markdownIt-Anchor" href="#原生-sql-进行分页查询时报错提示不能使用排序和分页"></a> 原生 sql 进行分页查询时报错提示不能使用排序和分页</h4>
<p>查询方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(value = &quot;select d.* from device d where d.sensor &amp; ?1 = ?1 &quot;</span></span><br><span class="line"><span class="meta">    ,nativeQuery = true</span></span><br><span class="line"><span class="meta">    ,countQuery = &quot;select count(*) from Device d where d.sensor &amp; ?1 = ?1&quot;)</span></span><br><span class="line">Page&lt;Device&gt; <span class="title function_">findBySensorType</span><span class="params">(Long sensorType,Pageable pageable)</span>;</span><br></pre></td></tr></table></figure>
<p>错误提示信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.data.jpa.repository.query.InvalidJpaQueryMethodException: </span><br><span class="line">Cannot use native queries with dynamic sorting and/or pagination in method public abstract org.springframework.data.domain.Page com.xx.xxxx.repository.XxxRepository.findBySensorType(java.lang.Long,org.springframework.data.domain.Pageable)</span><br></pre></td></tr></table></figure>
<p>解决方法是在查询语句中加上 <code>ORDER BY ?#&#123; #pageable &#125;</code> ，修改后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Query(value = &quot;select d.* from device d where d.sensor &amp; ?1 = ?1 order by ?#&#123; #pageable &#125;&quot;</span><br><span class="line">    ,nativeQuery = true</span><br><span class="line">    ,countQuery = &quot;select count(*) from Device d where d.sensor &amp; ?1 = ?1&quot;)</span><br><span class="line">Page&lt;Device&gt; findBySensorType(Long sensorType,Pageable pageable);</span><br></pre></td></tr></table></figure>
<h3 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h3>
<ul>
<li>springboot(十三)：springboot小技巧: <a target="_blank" rel="noopener" href="http://www.ityouknow.com/springboot/2017/06/22/springboot-tips.html">http://www.ityouknow.com/springboot/2017/06/22/springboot-tips.html</a></li>
<li>SpringBoot 2.x 整合 jpa实现多数据源: <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26440803/article/details/83316743">https://blog.csdn.net/qq_26440803/article/details/83316743</a></li>
</ul>
<h3 id="其它"><a class="markdownIt-Anchor" href="#其它"></a> 其它</h3>
<p>DEMO：<a target="_blank" rel="noopener" href="https://git.dev.tencent.com/wqf31415/springboot-jpa-demo.git">https://git.dev.tencent.com/wqf31415/springboot-jpa-demo.git</a><br />
由于笔者能力有限，文章中若有错误与不足之处希望大佬们能够指出。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/springboot/" rel="tag"># springboot</a>
              <a href="/tags/jpa/" rel="tag"># jpa</a>
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># 数据库</a>
              <a href="/tags/database/" rel="tag"># database</a>
              <a href="/tags/spring/" rel="tag"># spring</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/08/03/%E5%88%A9%E7%94%A8Excel%E5%92%8Cbat%E5%AF%B9%E6%96%87%E4%BB%B6%E6%89%B9%E9%87%8F%E9%87%8D%E5%91%BD%E5%90%8D/" rel="prev" title="利用Excel和bat对文件批量重命名">
                  <i class="fa fa-chevron-left"></i> 利用Excel和bat对文件批量重命名
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/01/11/JVM-%E8%B0%83%E4%BC%98%E5%88%9D%E6%8E%A2/" rel="next" title="JVM 调优初探">
                  JVM 调优初探 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">蜀ICP备18009638号 </a>
      <img src="http://blog-images.qiniu.wqf31415.xyz/beian_logo.png" alt=""><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51011502000320" rel="noopener" target="_blank">川公网安备 51011502000320号 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">This_Wei</span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js","integrity":"sha256-e0o3JYsdjqKajf9eOe22FhioYSz9WofRY4dLKo3F6do="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>




  





</body>
</html>
